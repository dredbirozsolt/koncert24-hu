

<div class="page-container">
    <% if (typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success"><%= success %></div>
    <% } %>
    <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-error"><%= error %></div>
    <% } %>

    <div class="admin-two-col">
        
        <!-- Bal oldal: Integration Forms -->
        <div>
            <!-- Vtiger CRM -->
            <div class="card--data">
                <h3 class="section-title">
                    üè¢ Vtiger CRM
                </h3>
                
                <form id="vtiger-form">
                    <div class="form__group">
                        <label for="vtiger.url">
                            Vtiger URL <span class="required-asterisk">*</span>
                        </label>
                        <input type="url" 
                               name="vtiger.url" 
                               id="vtiger.url"
                               class="form__control"
                               value="<%= flatSettings['vtiger.url'] || '' %>"
                               placeholder="https://your-instance.od2.vtiger.com"
                               required>
                    </div>

                    <div class="form__group">
                        <label for="vtiger.username">
                            Username <span class="required-asterisk">*</span>
                        </label>
                        <input type="text" 
                               name="vtiger.username" 
                               id="vtiger.username"
                               class="form__control"
                               value="<%= flatSettings['vtiger.username'] || '' %>"
                               placeholder="admin"
                               required>
                    </div>

                    <div class="form__group">
                        <label for="vtiger.access_key">
                            üîë Access Key <span class="required-asterisk">*</span>
                        </label>
                        <input type="password" 
                               name="vtiger.access_key" 
                               id="vtiger.access_key"
                               class="form__control"
                               value="<%= flatSettings['vtiger.access_key'] || '' %>"
                               placeholder="Access Key"
                               required>
                    </div>

                    <div class="btn__group btn__group--equal">
                        <button type="button" onclick="testVtiger()" class="btn btn--secondary">
                            ‚úì Teszt
                        </button>
                        <button type="submit" class="btn btn--primary">
                            üíæ Ment√©s
                        </button>
                    </div>
                </form>
            </div>

            <!-- Geonames API -->
            <div class="card--data integration-card-spacing">
                <h3 class="section-title">
                    üåç Geonames API
                </h3>
                
                <form id="geonames-form">
                    <div class="form__group">
                        <label for="geonames.username">
                            Username <span class="required-asterisk">*</span>
                        </label>
                        <input type="text" 
                               name="geonames.username" 
                               id="geonames.username"
                               class="form__control"
                               value="<%= flatSettings['geonames.username'] || '' %>"
                               placeholder="your-geonames-username"
                               required>
                    </div>

                    <div class="btn__group btn__group--equal">
                        <button type="button" onclick="testGeonames()" class="btn btn--secondary">
                            ‚úì Teszt
                        </button>
                        <button type="submit" class="btn btn--primary">
                            üíæ Ment√©s
                        </button>
                    </div>
                </form>
            </div>

            <!-- OpenAI API -->
            <div class="card--data integration-card-spacing">
                <h3 class="section-title">
                    ü§ñ OpenAI API (Chat AI)
                </h3>
                
                <form id="openai-form">
                    <div class="form__group">
                        <label for="chat.openai_api_key">
                            üîë API Key <span class="required-asterisk">*</span>
                        </label>
                        <input type="password" 
                               name="chat.openai_api_key" 
                               id="chat.openai_api_key"
                               class="form__control monospace-input"
                               value="<%= flatSettings['chat.openai_api_key'] || '' %>"
                               placeholder="sk-proj-..."
                               required>
                    </div>

                    <div class="btn__group btn__group--equal">
                        <button type="button" onclick="testOpenAI()" class="btn btn--secondary">
                            ‚úì Teszt
                        </button>
                        <button type="submit" class="btn btn--primary">
                            üíæ Ment√©s
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Jobb oldal: Info Panels -->
        <div>
            <!-- Vtiger Info -->
            <div class="card--data">
                <h3 class="section-title">
                    üè¢ Vtiger CRM
                </h3>
                
                <div class="integration-card__info-content">
                    <p>
                        <strong>üéØ Mire j√≥?</strong><br>
                        Automatikus lead √©s kontakt szinkroniz√°l√°s a Vtiger CRM rendszerrel.
                    </p>
                    
                    <p>
                        <strong>üîë Access Key:</strong><br>
                        Vtiger ‚Üí Settings ‚Üí My Preferences ‚Üí User Advanced Options
                    </p>
                    
                    <p>
                        <strong>‚úì Teszt funkci√≥:</strong><br>
                        Ellen≈ërzi a kapcsolatot √©s az API hozz√°f√©r√©st.
                    </p>
                </div>
            </div>

            <!-- Geonames Info -->
            <div class="card--data integration-card-spacing">
                <h3 class="section-title">
                    üåç Geonames API
                </h3>
                
                <div class="integration-card__info-content">
                    <p>
                        <strong>üåç Mire j√≥?</strong><br>
                        Automatikus helyadat kieg√©sz√≠t√©s esem√©nyekn√©l (v√°ros, orsz√°g, koordin√°t√°k).
                    </p>
                    
                    <p>
                        <strong>üìù Regisztr√°ci√≥:</strong><br>
                        Ingyenes fi√≥k: <a href="http://www.geonames.org/login" target="_blank" class="integration-link">geonames.org/login</a>
                    </p>
                    
                    <p>
                        <strong>‚ö° Haszn√°lat:</strong><br>
                        Automatikus, nincs tov√°bbi be√°ll√≠t√°s.
                    </p>
                </div>
            </div>

            <!-- OpenAI Info -->
            <div class="card--data integration-card-spacing">
                <h3 class="section-title">
                    ü§ñ OpenAI Chat AI
                </h3>
                
                <div class="integration-card__info-content">
                    <p>
                        <strong>ü§ñ Funkci√≥:</strong><br>
                        GPT-4 alap√∫ AI asszisztens a chat widgetben.
                    </p>
                    
                    <p>
                        <strong>üîó Regisztr√°ci√≥:</strong><br>
                        <a href="https://platform.openai.com/api-keys" target="_blank" class="integration-link">https://platform.openai.com/api-keys</a>
                    </p>
                    
                    <p>
                        <strong>‚öôÔ∏è Be√°ll√≠t√°s:</strong><br>
                        API kulcs itt, AI be/ki a <a href="/admin/chat/settings" class="integration-link">Chat Settings</a> oldalon.
                    </p>
                    
                    <p>
                        <strong>üîÑ M≈±k√∂d√©s:</strong><br>
                        Hibrid m√≥d: AI azonnali v√°lasz, admin √°tv√©tel lehets√©ges.
                    </p>
                </div>
            </div>

            <!-- St√°tusz -->
            <div class="card--data integration-card-spacing">
                <h3 class="section-title">
                    üìà Akt√≠v Integr√°ci√≥k
                </h3>
                
                <div class="integration-status-list">
                    <div class="integration-status-item">
                        <span>Vtiger CRM:</span>
                        <strong class="<%= flatSettings['vtiger.url'] ? 'status-active' : 'status-inactive' %>">
                            <%= flatSettings['vtiger.url'] ? '‚úì Be√°ll√≠tva' : '‚úó Nincs' %>
                        </strong>
                    </div>
                    <div class="integration-status-item">
                        <span>Geonames:</span>
                        <strong class="<%= flatSettings['geonames.username'] ? 'status-active' : 'status-inactive' %>">
                            <%= flatSettings['geonames.username'] ? '‚úì Be√°ll√≠tva' : '‚úó Nincs' %>
                        </strong>
                    </div>
                    <div class="integration-status-item">
                        <span>OpenAI API:</span>
                        <strong class="<%= flatSettings['chat.openai_api_key'] ? 'status-active' : 'status-inactive' %>">
                            <%= flatSettings['chat.openai_api_key'] ? '‚úì Be√°ll√≠tva' : '‚úó Nincs' %>
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
const csrfToken = '<%= csrfToken %>';

// Vtiger Form Submission
document.getElementById('vtiger-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveIntegration(e.target, 'vtiger');
});

// Geonames Form Submission
document.getElementById('geonames-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveIntegration(e.target, 'geonames');
});

// OpenAI Form Submission
document.getElementById('openai-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    await saveIntegration(e.target, 'openai');
});

// Save Integration Settings
async function saveIntegration(form, integration) {
    const formData = new FormData(form);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    try {
        const response = await fetch(`/admin/integrations/${integration}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message || `${integration.toUpperCase()} be√°ll√≠t√°sok sikeresen mentve!`);
        } else {
            showAlert('error', 'Hiba t√∂rt√©nt a ment√©s sor√°n: ' + (result.message || 'Ismeretlen hiba'));
        }
    } catch (error) {
        showAlert('error', 'H√°l√≥zati hiba t√∂rt√©nt');
        console.error('Error:', error);
    }
}

// Test Vtiger Connection
async function testVtiger() {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = 'Teszt folyamatban...';
    
    try {
        const response = await fetch('/admin/integrations/vtiger/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message || 'Vtiger kapcsolat sikeres');
        } else {
            showAlert('error', result.message || 'Vtiger teszt sikertelen');
        }
    } catch (error) {
        console.error('Vtiger test error:', error);
        showAlert('error', error.message || 'H√°l√≥zati hiba t√∂rt√©nt');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Test Geonames Connection
async function testGeonames() {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = 'Teszt folyamatban...';
    
    try {
        const response = await fetch('/admin/integrations/geonames/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message || 'Geonames kapcsolat sikeres');
        } else {
            showAlert('error', result.message || 'Geonames teszt sikertelen');
        }
    } catch (error) {
        console.error('Geonames test error:', error);
        showAlert('error', error.message || 'H√°l√≥zati hiba t√∂rt√©nt');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Test OpenAI Connection
async function testOpenAI() {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = 'Teszt folyamatban...';
    
    try {
        const response = await fetch('/admin/integrations/openai/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message || 'OpenAI kapcsolat sikeres');
        } else {
            showAlert('error', result.message || 'OpenAI teszt sikertelen');
        }
    } catch (error) {
        console.error('OpenAI test error:', error);
        showAlert('error', error.message || 'H√°l√≥zati hiba t√∂rt√©nt');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// ‚úÖ DESIGN SYSTEM: Uses global showAlert() from admin-alerts.js
// No local definition needed - automatically available on all admin pages
</script>
