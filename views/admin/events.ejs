<!-- Admin Events Management Page - Refactored -->
<!-- Using Design System -->


<div class="page-container">
    <!-- Success/Error Messages -->
    <% if (messages && messages.success) { %>
    <div class="alert alert-success"><%= messages.success %></div>
    <% } %>
    <% if (messages && messages.error) { %>
    <div class="alert alert-error"><%= messages.error %></div>
    <% } %>

    <!-- 2 oszlopos grid -->
    <div class="admin-two-col">
        <!-- BAL OSZLOP: Funkci√≥k √©s T√°bl√°zat -->
        <div>
            <!-- Statistics -->
            <div class="card--data">
                <h3>üìä Statisztik√°k</h3>
                <div class="stats-grid">
                    <div class="card--stat card--stat--primary">
                        <h3>üìä √ñsszes Esem√©ny</h3>
                        <div class="stat-value"><%= totalEvents %></div>
                    </div>
                    <div class="card--stat card--stat--success">
                        <h3>üéâ J√∂v≈ëbeli</h3>
                        <div class="stat-value"><%= upcomingEvents %></div>
                    </div>
                </div>
            </div>

            <!-- 1. Sync Settings Card -->
                        <!-- 1. Sync Settings Card -->
            <!-- 1. Sync Settings Card -->
            <div class="card--data">
        <h3 class="section-title">‚öôÔ∏è Szinkroniz√°l√°si Be√°ll√≠t√°sok</h3>
                <div class="flex gap-4 flex-wrap">
                    <div class="form__group flex-1">
                        <label class="form__label" for="syncMonthsBefore">
                            H√°ny h√≥nappal visszamen≈ëleg?
                        </label>
                        <input 
                            type="number" 
                            name="syncMonthsBefore" 
                            id="syncMonthsBefore"
                            class="form__input"
                            value="<%= syncMonthsBefore %>"
                            min="0"
                            max="12"
                        >
                        <small class="form__help">Pl: 1 = az elm√∫lt 1 h√≥nap esem√©nyeit</small>
                    </div>
                    
                    <div class="form__group flex-1">
                        <label class="form__label" for="syncMonthsAfter">
                            H√°ny h√≥nappal el≈ëre?
                        </label>
                        <input 
                            type="number" 
                            name="syncMonthsAfter"
                            id="syncMonthsAfter" 
                            class="form__input"
                            value="<%= syncMonthsAfter %>"
                            min="0"
                            max="24"
                        >
                        <small class="form__help">Pl: 1 = a k√∂vetkez≈ë 1 h√≥nap esem√©nyeit</small>
                    </div>
                </div>
                
                <div class="btn__group btn__group--equal mt-4">
                    <button type="button" id="sync-now-btn" class="btn btn--success">
                        üîÑ Szinkroniz√°l√°s Ind√≠t√°sa
                    </button>
                </div>
    </div>

            <!-- Events Table -->
            <div class="card--data">
        <% if (events.length === 0) { %>
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <div class="empty-state-title">M√©g nincsenek esem√©nyek</div>
                <div class="empty-state-text">Futtasd a szinkroniz√°l√°st a Vtiger esem√©nyeinek bet√∂lt√©s√©hez!</div>
            </div>
        <% } else { %>
            <div class="table-responsive max-h-80vh overflow-auto">
                <table class="table table-hover table-compact">
                    <thead>
                        <tr>
                            <th>T√°rgy</th>
                            <th>El≈ëad√≥</th>
                            <th>Helysz√≠n</th>
                            <th class="text-center">M≈±veletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% events.forEach(event => { %>
                            <tr data-event-id="<%= event.id %>">
                                <td class="wrap-text">
                                    <strong><%= event.subject %></strong>
                                </td>
                                <td>
                                    <% if (event.performer) { %>
                                        <a href="/admin/performers/<%= event.performer.id %>">
                                            <%= event.performer.name %>
                                        </a>
                                    <% } else { %>
                                        -
                                    <% } %>
                                </td>
                                <td class="wrap-text">
                                    <% if (event.performanceLocation) { %>
                                        <%= event.performanceLocation %>
                                    <% } else { %>
                                        -
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <button 
                                        onclick="deleteEvent(<%= event.id %>)" 
                                        class="btn btn-icon-only btn-error"
                                        title="Esem√©ny t√∂rl√©se"
                                    >
                                        üóëÔ∏è
                                    </button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>
        </div>
        <!-- /.bal oszlop -->

        <!-- JOBB OSZLOP: Info Boxok -->
        <div>
            
            <!-- Szinkroniz√°l√°s -->
            <div class="card--data">
                <h3 class="section-title">
                    üîÑ Automatikus Szinkroniz√°l√°s
                </h3>
                <div class="card__info-content">
                    <p>Az esem√©nyek automatikusan szinkroniz√°l√≥dnak a Jegymester API-b√≥l.</p>
                    
                    <p><strong>Hogyan m≈±k√∂dik?</strong></p>
                    <ul>
                        <li>Naponta automatikus szinkroniz√°l√°s (cron job)</li>
                        <li>A be√°ll√≠tott id≈ëtartom√°nyban l√©v≈ë esem√©nyek let√∂lt√©se</li>
                        <li>√öj esem√©nyek hozz√°ad√°sa, megl√©v≈ëk friss√≠t√©se</li>
                        <li>Id≈ëhat√°rokon k√≠v√ºl es≈ë esem√©nyek automatikus t√∂rl√©se</li>
                        <li>Duplik√°tumok automatikus kezel√©se</li>
                    </ul>
                    
                    <p>
                        ‚è±Ô∏è A szinkroniz√°l√°s minden nap hajnalban fut le automatikusan.
                    </p>
                </div>
            </div>

            <!-- Id≈ëtartom√°ny Be√°ll√≠t√°sok -->
            <div class="card--data">
                <h3 class="section-title">
                    üìÖ Id≈ëtartom√°ny Be√°ll√≠t√°sok
                </h3>
                <div class="card__info-content">
                    <p>√Åll√≠tsd be, hogy mennyi ideig visszamen≈ëleg √©s el≈ëre t√∂lt≈ëdjenek le az esem√©nyek.</p>
                    
                    <p><strong>H√≥napok visszamen≈ëleg:</strong></p>
                    <p>
                        H√°ny h√≥nappal ezel≈ëtti esem√©nyeket t√∂lts√∂n le a rendszer.<br>
                        <em>P√©lda: 1 h√≥nap = az elm√∫lt 30 nap esem√©nyeit</em>
                    </p>
                    
                    <p><strong>H√≥napok el≈ëre:</strong></p>
                    <p>
                        H√°ny h√≥nappal el≈ëre t√∂lt≈ëdjenek le a j√∂v≈ëbeli esem√©nyek.<br>
                        <em>P√©lda: 6 h√≥nap = a k√∂vetkez≈ë 6 h√≥nap esem√©nyeit</em>
                    </p>
                    
                    <p>
                        üí° Aj√°nlott: 1 h√≥nap vissza, 6-12 h√≥nap el≈ëre
                    </p>
                </div>
            </div>

            <!-- Esem√©ny St√°tuszok -->
            <div class="card--data">
                <h3 class="section-title">
                    ‚úì Esem√©ny St√°tuszok
                </h3>
                <div class="card__info-content">
                    <div>
                        <strong>‚úÖ Approved:</strong>
                        <p>J√≥v√°hagyott esem√©ny, megjelenik a weboldalon</p>
                    </div>
                    <div>
                        <strong>‚è≥ Pending:</strong>
                        <p>F√ºgg≈ëben l√©v≈ë esem√©ny, m√©g nem v√©gleges</p>
                    </div>
                    <div>
                        <strong>‚ùå Cancelled:</strong>
                        <p>Lemondott esem√©ny, nem jelenik meg</p>
                    </div>
                    
                    <p>
                        ‚ÑπÔ∏è A st√°tusz a Jegymester rendszer√©b≈ël √©rkezik automatikusan.
                    </p>
                </div>
            </div>

            <!-- El≈ëad√≥k √©s Helysz√≠nek -->
            <div class="card--data">
                <h3 class="section-title">
                    üé§ El≈ëad√≥k √©s Helysz√≠nek
                </h3>
                <div class="card__info-content">
                    <p><strong>El≈ëad√≥ (Performer):</strong></p>
                    <p>
                        Az esem√©ny m≈±v√©sze vagy el≈ëad√≥ja. Ha van el≈ëad√≥ oldal, kattinthat√≥ link lesz.
                    </p>
                    
                    <p><strong>Helysz√≠n (Venue):</strong></p>
                    <p>
                        Az esem√©ny pontos helysz√≠ne (pl. Pet≈ëfi Csarnok, Budapest).
                    </p>
                    
                    <p><strong>T√©tel (Item):</strong></p>
                    <p>
                        Az esem√©ny t√≠pusa vagy kateg√≥ri√°ja a Jegymester rendszer√©ben.
                    </p>
                </div>
            </div>

            <!-- Szinkroniz√°l√°si Eredm√©nyek -->
            <div class="card--data">
                <h3 class="section-title">
                    üìä Szinkroniz√°l√°si Eredm√©nyek
                </h3>
                <div class="card__info-content">
                    <p>A szinkroniz√°l√°s ut√°n r√©szletes statisztik√°t l√°tsz:</p>
                    
                    <ul>
                        <li>
                            <strong>Feldolgozott:</strong> H√°ny esem√©nyt dolgozott fel a rendszer
                        </li>
                        <li>
                            <strong>L√©trehozott:</strong> H√°ny √∫j esem√©ny ker√ºlt hozz√°ad√°sra
                        </li>
                        <li>
                            <strong>Friss√≠tett:</strong> H√°ny megl√©v≈ë esem√©ny friss√ºlt
                        </li>
                        <li>
                            <strong>T√∂r√∂lve:</strong> H√°ny esem√©ny ker√ºlt t√∂rl√©sre (id≈ëhat√°rokon k√≠v√ºl)
                        </li>
                        <li>
                            <strong>Hib√°k:</strong> H√°ny esem√©nyn√©l t√∂rt√©nt hiba
                        </li>
                        <li>
                            <strong>Id≈ëtartam:</strong> Mennyi ideig tartott a szinkroniz√°l√°s (milliszekundumban)
                        </li>
                    </ul>
                    
                    <p>
                        ‚ÑπÔ∏è A szinkroniz√°l√°s ut√°n az oldal automatikusan friss√ºl.
                    </p>
                </div>
            </div>
        </div>
        <!-- /.jobb oszlop -->
    </div>
    <!-- /.content-grid -->
</div>
<!-- /.page-container -->

<script>
// Auto-save be√°ll√≠t√°sok amikor v√°ltoznak
const syncInputs = ['syncMonthsBefore', 'syncMonthsAfter'];

syncInputs.forEach(inputId => {
    const inputElement = document.getElementById(inputId);
    if (inputElement) {
        inputElement.addEventListener('change', async function() {
            const input = this;
            const originalValue = input.value;
            
            try {
                const data = {
                    [inputId]: input.value
                };
                
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                const response = await fetch('/admin/events/settings', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const labelElement = input.closest('.form__group')?.querySelector('.form__label');
                    const label = labelElement ? labelElement.textContent.trim() : inputId;
                    showAlert('success', '‚úÖ Mentve: ' + label);
                } else {
                    throw new Error('Save failed: ' + response.status);
                }
            } catch (error) {
                console.error('‚ùå Auto-save error:', error);
                // Revert input value
                input.value = originalValue;
                showAlert('error', '‚ùå Ment√©s sikertelen');
            }
        });
    }
});

// Szinkroniz√°l√°s gomb
document.getElementById('sync-now-btn').addEventListener('click', async function() {
    const btn = this;
    const originalBtnText = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Szinkroniz√°l√°s folyamatban...';
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        const response = await fetch('/admin/events/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', `‚úÖ Szinkroniz√°l√°s befejezve! ${result.message}`);
            
            // Oldal √∫jrat√∂lt√©se 3 m√°sodperc m√∫lva
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            showAlert('error', result.message || 'Hiba t√∂rt√©nt a szinkroniz√°l√°s sor√°n');
        }
    } catch (error) {
        console.error('Sync error:', error);
        showAlert('error', error.message || 'H√°l√≥zati hiba t√∂rt√©nt');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnText;
    }
});

// Esem√©ny t√∂rl√©se
async function deleteEvent(eventId) {
    const confirmed = await Modal.confirm({
        title: 'Esem√©ny t√∂rl√©se',
        message: 'Biztosan t√∂r√∂lni szeretn√©d ezt az esem√©nyt?',
        confirmText: 'T√∂rl√©s',
        cancelText: 'M√©gse'
    });
    
    if (!confirmed) {
        return;
    }
    
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        const response = await fetch('/admin/events/' + eventId, {
            method: 'DELETE',
            headers: {
                'X-CSRF-Token': csrfToken
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Sor elt√°vol√≠t√°sa a t√°bl√°zatb√≥l
            const row = document.querySelector('tr[data-event-id="' + eventId + '"]');
            if (row) {
                row.remove();
            }
            Modal.alert({
                title: 'Siker',
                message: 'Esem√©ny sikeresen t√∂r√∂lve',
                type: 'success'
            });
        } else {
            Modal.alert({
                title: 'Hiba',
                message: result.message || 'Hiba t√∂rt√©nt a t√∂rl√©s sor√°n',
                type: 'error'
            });
        }
    } catch (error) {
        Modal.alert({
            title: 'Hiba',
            message: 'H√°l√≥zati hiba t√∂rt√©nt',
            type: 'error'
        });
        console.error('Error:', error);
    }
}

// Oldal bet√∂lt√©skor alap√©rtelmezett d√°tumok be√°ll√≠t√°sa
document.addEventListener('DOMContentLoaded', () => {
    setDefaultDates();
});
</script>
