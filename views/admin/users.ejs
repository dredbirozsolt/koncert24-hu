

<!-- Admin Users Management -->

<div class="page-container">
    <% if (messages.success) { %>
    <div class="alert alert-success"><%= messages.success %></div>
    <% } %>
    <% if (messages.error) { %>
    <div class="alert alert-error"><%= messages.error %></div>
    <% } %>

    <!-- 2-Column Grid Layout -->
    <div class="admin-two-col">
        
        <!-- Left Column: Main Content -->
        <div>

    <!-- Statistics -->
    <div class="card--data">
        <h3>ÔøΩ Statisztik√°k</h3>
        <div class="stats-grid">
            <div class="card--stat card--stat--warning">
                <h3>üëë Admin</h3>
                <div class="stat-value"><%= users.filter(u => u.role === 'admin').length %></div>
            </div>
            <div class="card--stat card--stat--info">
                <h3>üíº √ârt√©kes√≠t≈ë</h3>
                <div class="stat-value"><%= users.filter(u => u.role === 'sales').length %></div>
            </div>
            <div class="card--stat card--stat--primary">
                <h3>üé§ El≈ëad√≥</h3>
                <div class="stat-value"><%= users.filter(u => u.role === 'performer').length %></div>
            </div>
            <div class="card--stat card--stat--success">
                <h3>üë§ Megrendel≈ë</h3>
                <div class="stat-value"><%= users.filter(u => u.role === 'client').length %></div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card--data">
        <h3>üîç Sz≈±r√©s</h3>
        <form method="GET" action="/admin/users">
            <div class="filter-grid-4-col">
                <div class="form__group">
                    <label>Keres√©s</label>
                    <input type="text" name="search" class="form__control"
                           placeholder="N√©v, email, telefon..."
                           value="<%= filters.search || '' %>">
                </div>
                <div class="form__group">
                    <label>Szerepk√∂r</label>
                    <select name="role" class="form__select">
                        <option value="">√ñsszes</option>
                        <option value="admin" <%= filters.role === 'admin' ? 'selected' : '' %>>Adminisztr√°tor</option>
                        <option value="sales" <%= filters.role === 'sales' ? 'selected' : '' %>>√ârt√©kes√≠t≈ë</option>
                        <option value="client" <%= filters.role === 'client' ? 'selected' : '' %>>Megrendel≈ë</option>
                        <option value="performer" <%= filters.role === 'performer' ? 'selected' : '' %>>El≈ëad√≥</option>
                    </select>
                </div>
                <div class="form__group">
                    <label>√Ållapot</label>
                    <select name="status" class="form__select">
                        <option value="">üîò √ñsszes</option>
                        <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>‚úÖ Akt√≠v</option>
                        <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>‚ùå Inakt√≠v</option>
                    </select>
                </div>
                <div class="form__group">
                    <button type="submit" class="btn btn--primary w-full">
                        üîç Sz≈±r√©s
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Action Button -->
    <div class="btn__group btn__group--equal mb-4">
        <a href="/admin/users/new" class="btn btn--primary">
            ‚ûï √öj Felhaszn√°l√≥
        </a>
    </div>

    <!-- Users Table -->
    <div class="card--data">
        <h3>üë• Felhaszn√°l√≥k List√°ja</h3>
        <% if (users.length === 0) { %>
            <div class="empty-state">
                <h3>üòï Nincs megjelen√≠thet≈ë felhaszn√°l√≥</h3>
                <p>Pr√≥b√°ljon m√°s sz≈±r√©si felt√©teleket.</p>
            </div>
        <% } else { %>
            <div class="table--responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>N√©v</th>
                            <th>Szerepk√∂r</th>
                            <th>√Ållapot</th>
                            <th>Regisztr√°lt</th>
                            <th>M≈±veletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(function(userData) { %>
                            <tr>
                                <td data-label="N√©v">
                                    <strong><%= userData.name %></strong>
                                </td>
                                <td data-label="Szerepk√∂r">
                                    <% if (userData.role === 'admin') { %>
                                        <span class="badge badge-error">üëë Admin</span>
                                    <% } else if (userData.role === 'sales') { %>
                                        <span class="badge badge-primary">üíº √ârt√©kes√≠t≈ë</span>
                                    <% } else if (userData.role === 'client') { %>
                                        <span class="badge badge-success">üë§ Megrendel≈ë</span>
                                    <% } else if (userData.role === 'performer') { %>
                                        <span class="badge badge-warning">üé§ El≈ëad√≥</span>
                                    <% } %>
                                </td>
                                <td data-label="√Ållapot">
                                    <button type="button" 
                                            class="status-toggle <%= userData.isActive ? 'status-toggle--active' : 'status-toggle--inactive' %>" 
                                            data-user-id="<%= userData.id %>"
                                            data-current-status="<%= userData.isActive %>"
                                            onclick="toggleUserStatus(this)"
                                            title="Kattints az √°llapot v√°lt√°s√°hoz">
                                        <span class="status-toggle__label">
                                            <%= userData.isActive ? 'Akt√≠v' : 'Inakt√≠v' %>
                                        </span>
                                    </button>
                                </td>
                                <td data-label="Regisztr√°lt"><%= new Date(userData.createdAt).toLocaleDateString('hu-HU') %></td>
                                <td data-label="M≈±veletek">
                                    <div class="actions">
                                        <a href="/admin/users/<%= userData.id %>/edit" class="btn btn-icon-only btn--secondary" title="Szerkeszt√©s">
                                            ‚úèÔ∏è
                                        </a>
                                        <button class="btn btn-icon-only btn-error delete-user" 
                                                data-id="<%= userData.id %>" 
                                                data-name="<%= userData.name %>"
                                                data-email="<%= userData.email %>"
                                                title="T√∂rl√©s">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>

        </div> <!-- End Left Column -->

        <!-- Right Column: Info Boxes -->
        <div>
            <!-- Szerepk√∂r√∂k -->
            <div class="card--data">
                <h3>üë• Szerepk√∂r√∂k</h3>
                <div class="card__info-content">
                    <p><strong>üëë Admin</strong> - Teljes hozz√°f√©r√©s az admin fel√ºlethez. Minden funkci√≥ el√©rhet≈ë.</p>
                    <p><strong>üíº √ârt√©kes√≠t≈ë</strong> - Korl√°tozott hozz√°f√©r√©s. Csak az √©rt√©kes√≠t√©si modulokhoz f√©r hozz√°.</p>
                    <p><strong>üé§ El≈ëad√≥</strong> - El≈ëad√≥i profil kezel√©se, napt√°r, foglal√°sok megtekint√©se.</p>
                    <p><strong>üë§ Megrendel≈ë</strong> - √úgyf√©loldali hozz√°f√©r√©s. Saj√°t foglal√°sok, rendel√©sek kezel√©se.</p>
                </div>
            </div>

            <!-- Felhaszn√°l√≥ Kezel√©se -->
            <div class="card--data">
                <h3>‚öôÔ∏è Felhaszn√°l√≥ Kezel√©se</h3>
                <div class="card__info-content">
                    <p><strong>√öj felhaszn√°l√≥:</strong></p>
                    <ul>
                        <li>Kattints a <strong>‚ûï √öj Felhaszn√°l√≥</strong> gombra</li>
                        <li>T√∂ltsd ki a k√∂telez≈ë mez≈ëket</li>
                        <li>V√°laszd ki a szerepk√∂rt</li>
                        <li>√Åll√≠tsd be az akt√≠v st√°tuszt</li>
                    </ul>
                    <p><strong>Szerkeszt√©s:</strong> Kattints a ‚úèÔ∏è ikonra</p>
                    <p><strong>T√∂rl√©s:</strong> Kattints a üóëÔ∏è ikonra (visszavonhatatlan!)</p>
                </div>
            </div>

            <!-- √Ållapot V√°lt√°s -->
            <div class="card--data">
                <h3>üîÑ √Ållapot V√°lt√°s</h3>
                <div class="card__info-content">
                    <p>A <strong>st√°tusz gombra kattintva</strong> azonnal aktiv√°lhatod vagy deaktiv√°lhatod a felhaszn√°l√≥t.</p>
                    <p><strong>Akt√≠v:</strong> A felhaszn√°l√≥ be tud jelentkezni √©s haszn√°lhatja a rendszert.</p>
                    <p><strong>Inakt√≠v:</strong> A felhaszn√°l√≥ nem tud bejelentkezni. Adatai megmaradnak.</p>
                    <p>‚ö†Ô∏è Az √°llapot v√°lt√°s azonnal √©rv√©nybe l√©p!</p>
                </div>
            </div>

            <!-- Sz≈±r√©s √©s Keres√©s -->
            <div class="card--data">
                <h3>üîç Sz≈±r√©s √©s Keres√©s</h3>
                <div class="card__info-content">
                    <p><strong>Keres√©s</strong> - N√©v, email vagy telefonsz√°m alapj√°n</p>
                    <p><strong>Szerepk√∂r</strong> - Sz≈±r√©s szerepk√∂r szerint</p>
                    <p><strong>√Ållapot</strong> - Csak akt√≠v vagy inakt√≠v felhaszn√°l√≥k</p>
                    <p>A sz≈±r≈ëk kombin√°lhat√≥k. A keres√©s val√≥s id≈ëben t√∂rt√©nik a t√°bl√°zatban.</p>
                </div>
            </div>
        </div>

    </div> <!-- End Grid -->
</div> <!-- End page-container -->

<script>
// Toggle user status (Active/Inactive)
async function toggleUserStatus(button) {
    const userId = button.dataset.userId;
    const currentStatus = button.dataset.currentStatus === 'true';
    const newStatus = !currentStatus;
    
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="status-toggle__label">‚è≥...</span>';
    
    try {
        // Haszn√°ljuk a window.location.origin-t hogy a megfelel≈ë protokollt haszn√°ljuk
        const url = `${window.location.origin}/admin/users/${userId}/toggle`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '<%= csrfToken %>'
            },
            body: JSON.stringify({ isActive: newStatus })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Update button state
            button.dataset.currentStatus = newStatus;
            button.className = `status-toggle ${newStatus ? 'status-toggle--active' : 'status-toggle--inactive'}`;
            button.innerHTML = `<span class="status-toggle__label">${newStatus ? 'Akt√≠v' : 'Inakt√≠v'}</span>`;
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '1000';
            alertDiv.textContent = data.message || 'Felhaszn√°l√≥ √°llapota friss√≠tve!';
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        } else {
            throw new Error(data.message || 'Hiba t√∂rt√©nt');
        }
    } catch (error) {
        alert('‚ùå Hiba: ' + error.message);
        button.innerHTML = originalHTML;
    } finally {
        button.disabled = false;
    }
}

document.querySelectorAll('.delete-user').forEach(btn => {
    btn.addEventListener('click', async function() {
        const name = this.dataset.name;
        const email = this.dataset.email;
        const id = this.dataset.id;
        
        const confirmed = await Modal.confirm({
            title: 'Felhaszn√°l√≥ t√∂rl√©se',
            message: 'Biztosan t√∂r√∂lni szeretn√©d ezt a felhaszn√°l√≥t?',
            confirmText: 'T√∂rl√©s',
            cancelText: 'M√©gse'
        });
        
        if (confirmed) {
            try {
                // Haszn√°ljuk a window.location.origin-t hogy a megfelel≈ë protokollt haszn√°ljuk
                const url = `${window.location.origin}/admin/users/${id}/delete`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': '<%= csrfToken %>'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    Modal.alert({
                        title: 'Siker',
                        message: data.message || 'Felhaszn√°l√≥ sikeresen t√∂r√∂lve!',
                        type: 'success'
                    });
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error(data.message || 'Hiba t√∂rt√©nt a t√∂rl√©s sor√°n');
                }
            } catch (error) {
                Modal.alert({
                    title: 'Hiba',
                    message: error.message,
                    type: 'error'
                });
            }
        }
    });
});
</script>
