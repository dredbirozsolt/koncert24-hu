<!-- Backup Page - 2 Column Layout -->
<!-- Using Design System -->

<div class="page-container">
    <% if (messages && messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
    <% } %>
    <% if (messages && messages.error) { %>
        <div class="alert alert-error"><%= messages.error %></div>
    <% } %>

    <div class="admin-two-col">
        <!-- Bal oldal: Backup Management -->
        <div>
            <!-- 1. Backup Be√°ll√≠t√°sok -->
            <div class="card--data">
                <h3 class="section-title">
                    ‚öôÔ∏è Backup Be√°ll√≠t√°sok
                </h3>
                
                <form id="backup-settings-form">
                    <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">
                    
                    <div>
                        <div class="form__group">
                            <label for="maxCount" class="form__label">
                                üìä Maximum Darabsz√°m
                            </label>
                            <input 
                                type="number" 
                                id="maxCount" 
                                name="maxCount" 
                                value="<%= settings.maxCount %>"
                                min="1"
                                max="100"
                                class="form__control"
                                required
                            >
                            <small class="form__hint">
                                Ennyi backup maradhat meg egyszerre
                            </small>
                        </div>
                        
                        <div class="form__group">
                            <label for="maxAgeDays" class="form__label">
                                üìÖ Maximum Kor (napok)
                            </label>
                            <input 
                                type="number" 
                                id="maxAgeDays" 
                                name="maxAgeDays" 
                                value="<%= settings.maxAgeDays %>"
                                min="1"
                                max="365"
                                class="form__control"
                                required
                            >
                            <small class="form__hint">
                                Enn√©l r√©gebbi backupok t√∂rl≈ëdnek
                            </small>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Manual Backup Action -->
            <div class="btn__group btn__group--equal mb-4">
                <button type="button" class="btn btn--primary" onclick="runManualBackup()">
                    Manu√°lis Backup Ind√≠t√°sa
                </button>
            </div>

            <!-- 2. Backup Lista -->
            <div class="card--data">
                <h3 class="section-title">
                    üìÇ Backup Lista
                </h3>
                
                <% if (backupInfo.backups && backupInfo.backups.length > 0) { %>
                    <div class="table--responsive">
                        <table class="table table-hover table-compact">
                            <thead>
                                <tr>
                                    <th>F√°jln√©v</th>
                                    <th>L√©trehozva</th>
                                    <th>M√©ret</th>
                                    <th>M≈±veletek</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% backupInfo.backups.forEach(backup => { %>
                                <tr>
                                    <td data-label="F√°jln√©v">
                                        <strong><%= backup.name %></strong>
                                    </td>
                                    <td data-label="L√©trehozva">
                                        <%= new Date(backup.created).toLocaleString('hu-HU') %>
                                    </td>
                                    <td data-label="M√©ret">
                                        <%= (backup.size / 1024 / 1024).toFixed(2) %> MB
                                    </td>
                                    <td data-label="M≈±veletek">
                                        <button type="button" class="btn btn--primary btn--sm" onclick="downloadBackup('<%= backup.name %>')">
                                            Let√∂lt√©s
                                        </button>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                    </div>
                <% } else { %>
                    <div class="empty-state">
                        <h3>üì≠ M√©g nincs egyetlen backup sem</h3>
                        <p>Kattints a "Manu√°lis Backup" gombra az els≈ë ment√©s l√©trehoz√°s√°hoz.</p>
                    </div>
                <% } %>
            </div>
        </div>

        <!-- Jobb oldal: Info Panels -->
        <div>
            <!-- Backup Info -->
            <div class="card--data">
                <h3 class="section-title">
                    ‚ÑπÔ∏è Mi az a Backup?
                </h3>
                
                <div>
                    <p>
                        <strong>üíæ Biztons√°gi Ment√©s:</strong><br>
                        A backup egy teljes m√°solat az adatb√°zisr√≥l, felt√∂lt√∂tt f√°jlokr√≥l √©s konfigur√°ci√≥s √°llom√°nyokr√≥l.
                    </p>
                    
                    <p>
                        <strong>üîÑ Automatikus ment√©s:</strong><br>
                        A rendszer naponta automatikusan k√©sz√≠t backup-ot a be√°ll√≠tott id≈ëpontban.
                    </p>
                    
                    <p>
                        <strong>‚ö° Manu√°lis ment√©s:</strong><br>
                        A "Manu√°lis Backup" gombbal b√°rmikor k√©sz√≠thetsz azonnali ment√©st.
                    </p>
                </div>
            </div>

            <!-- Backup Strat√©gia -->
            <div class="card--data">
                <h3 class="section-title">
                    üõ°Ô∏è Backup Strat√©gia
                </h3>
                
                <div>
                    <p>
                        <strong>üìä Max Darabsz√°m:</strong><br>
                        Ennyi backup marad meg a rendszerben. Ha t√∂bb k√©sz√ºl, a legr√©gebbit t√∂rli.
                    </p>
                    
                    <p>
                        <strong>üìÖ Max Kor:</strong><br>
                        Az enn√©l r√©gebbi backupok automatikusan t√∂rl≈ëdnek, f√ºggetlen√ºl a darabsz√°mt√≥l.
                    </p>
                    
                    <p>
                        <strong>üîí Biztons√°g:</strong><br>
                        Mindk√©t szab√°ly egy√ºtt √©rv√©nyes√ºl, √≠gy garant√°lt a friss √©s korl√°tozott t√°rhely.
                    </p>
                </div>
            </div>

            <!-- Backup Tartalom -->
            <div class="card--data">
                <h3 class="section-title">
                    üì¶ Mit Tartalmaz?
                </h3>
                
                <div>
                    <div>
                        <strong>üóÑÔ∏è Adatb√°zis</strong><br>
                        Teljes MySQL dump az √∂sszes t√°bl√°val √©s adattal.
                    </div>
                    
                    <div>
                        <strong>üìÅ F√°jlok</strong><br>
                        Felt√∂lt√∂tt k√©pek, dokumentumok, m√©dia f√°jlok.
                    </div>
                    
                    <div>
                        <strong>‚öôÔ∏è Konfigur√°ci√≥</strong><br>
                        .env f√°jl, be√°ll√≠t√°sok, egy√©b konfigok.
                    </div>
                </div>
            </div>

            <!-- Vissza√°ll√≠t√°s -->
            <div class="card--data">
                <h3 class="section-title">
                    ‚Ü©Ô∏è Vissza√°ll√≠t√°s
                </h3>
                
                <div>
                    <p>
                        <strong>‚¨áÔ∏è Let√∂lt√©s:</strong><br>
                        Kattints a "Let√∂lt√©s" gombra b√°rmelyik backup mellett.
                    </p>
                    
                    <p>
                        <strong>üì¶ Form√°tum:</strong><br>
                        A backup .tar.gz form√°tum√∫, t√∂m√∂r√≠tett arch√≠vum.
                    </p>
                    
                    <p>
                        <strong>üîß Helyre√°ll√≠t√°s:</strong><br>
                        Haszn√°ld a <code>restore.sh</code> scriptet vagy √°ll√≠tsd vissza manu√°lisan.
                    </p>
                </div>
            </div>

            <!-- Automatiz√°l√°s -->
            <div class="card--data">
                <h3 class="section-title">
                    ‚è∞ Automatiz√°l√°s
                </h3>
                
                <div>
                    <p>
                        <strong>‚è∞ Cron Job:</strong><br>
                        A <code>backup.sh</code> script fut naponta a megadott id≈ëpontban.
                    </p>
                    
                    <p>
                        <strong>üßπ Automatikus Tiszt√≠t√°s:</strong><br>
                        A r√©gi backupok t√∂rl√©se a be√°ll√≠t√°soknak megfelel≈ëen.
                    </p>
                    
                    <p>
                        <strong>üìä Statisztika:</strong><br>
                        Jelenleg <strong><%= backupInfo.backups ? backupInfo.backups.length : 0 %></strong> backup van mentve.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const csrfToken = '<%= csrfToken || "" %>';

// Auto-save for number inputs (maxCount, maxAgeDays)
document.querySelectorAll('#backup-settings-form input[type="number"]').forEach(input => {
    input.addEventListener('blur', async function() {
        const value = parseInt(this.value);
        const min = parseInt(this.min);
        const max = parseInt(this.max);
        
        // Validate min/max
        if (value < min || value > max) {
            showAlert('error', `‚ùå √ârt√©k ${min} √©s ${max} k√∂z√∂tt kell legyen`);
            this.value = this.defaultValue;
            return;
        }
        
        await saveSingleSetting(this.name, this.value);
    });
});

// Auto-save single setting function
async function saveSingleSetting(fieldName, value) {
    const maxCount = document.getElementById('maxCount').value;
    const maxAgeDays = document.getElementById('maxAgeDays').value;
    
    try {
        const response = await fetch('/admin/backup/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ maxCount, maxAgeDays })
        });
        
        const data = await response.json();
        
        if (data.success) {
            const label = fieldName === 'maxCount' ? 'Maximum Darabsz√°m' : 'Maximum Kor';
            showAlert('success', `‚úÖ Mentve: ${label}`);
        } else {
            showAlert('error', `‚ùå ${data.error || 'Hiba t√∂rt√©nt'}`);
        }
    } catch (error) {
        showAlert('error', '‚ùå H√°l√≥zati hiba t√∂rt√©nt');
    }
}

// ‚úÖ DESIGN SYSTEM: Uses global showAlert() from admin-alerts.js
// No local definition needed - automatically available on all admin pages

// Manual backup function
async function runManualBackup() {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = 'Backup folyamatban...';
    
    try {
        const response = await fetch('/admin/backup/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', 'Backup sikeresen elk√©sz√ºlt');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert('error', data.error || 'Backup hiba t√∂rt√©nt');
        }
    } catch (error) {
        console.error('Backup error:', error);
        showAlert('error', error.message || 'H√°l√≥zati hiba t√∂rt√©nt');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// ‚úÖ DESIGN SYSTEM: Uses global showAlert() from admin-alerts.js
// No local definition needed - automatically available on all admin pages

// Download backup function
function downloadBackup(backupName) {
    window.location.href = `/admin/backup/download/${encodeURIComponent(backupName)}`;
}
</script>
