<!-- Chat Settings Page -->
<div class="page-container">
    <div class="admin-two-col">
        
        <!-- Bal oldal: Settings Form -->
        <div>
            <form id="chat-settings-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                
                <!-- General Settings -->
                <div class="card--data">
                    <h3 class="section-title">
                        ‚öôÔ∏è √Åltal√°nos Be√°ll√≠t√°sok
                    </h3>
                    
                    <!-- Chat Enabled -->
                    <div class="form__group">
                        <div class="form__label-with-toggle">
                            <span class="form__label">Chat Rendszer</span>
                            <input type="checkbox" 
                                   class="form-switch-input"
                                   name="chat.enabled" 
                                   id="chat.enabled"
                                   value="true"
                                   <%= chatEnabled ? 'checked' : '' %>>
                        </div>
                        <small class="form__hint">A chat widget megjelen√≠t√©se a weboldalon</small>
                    </div>

                    <!-- AI Enabled -->
                    <div class="form__group">
                        <div class="form__label-with-toggle">
                            <span class="form__label">AI Asszisztens</span>
                            <input type="checkbox" 
                                   class="form-switch-input"
                                   name="chat.ai_enabled" 
                                   id="chat.ai_enabled"
                                   value="true"
                                   <%= aiEnabled ? 'checked' : '' %>>
                        </div>
                        <small class="form__hint">
                            OpenAI GPT-4 alap√∫ v√°laszok ‚Ä¢ 
                            <a href="/admin/integrations">API kulcs be√°ll√≠t√°sa</a>
                        </small>
                    </div>

                    <!-- √ârt√©kes√≠t≈ëi Chat Enabled -->
                    <div class="form__group">
                        <div class="form__label-with-toggle">
                            <span class="form__label">√ârt√©kes√≠t≈ëi Chat</span>
                            <input type="checkbox" 
                                   class="form-switch-input"
                                   name="chat.admin_chat_enabled" 
                                   id="chat.admin_chat_enabled"
                                   value="true"
                                   <%= adminChatEnabled ? 'checked' : '' %>>
                        </div>
                        <small class="form__hint">√ârt√©kes√≠t≈ëk csatlakozhatnak a chat-hez</small>
                    </div>

                    <!-- Auto Offline Minutes -->
                    <div class="form__group mt-6 pt-6 border-t">
                        <label class="form__label" for="chat.auto_offline_minutes">
                            ‚è±Ô∏è Auto-Offline Id≈ë
                        </label>
                        <div class="form__input-group">
                            <input 
                                type="number" 
                                class="form__control" 
                                id="chat.auto_offline_minutes" 
                                name="chat.auto_offline_minutes"
                                value="<%= autoOfflineMinutes %>"
                                min="5"
                                max="60"
                                required
                            />
                            <span class="form__input-group-text">perc</span>
                        </div>
                        <small class="form__hint">
                            Inaktivit√°s ut√°n automatikus offline (5-60 perc)
                        </small>
                    </div>
                </div>

                <!-- Offline Messages Management -->
                <div class="card--data">
                    <h3 class="section-title">
                        üì® Offline √úzenetek Kezel√©se
                    </h3>
                    
                    <!-- Offline Messages Retention Days -->
                    <div class="form__group">
                        <label class="form__label" for="offline_messages.retention_days">
                            üìÖ Lez√°rt √úzenetek Meg≈ërz√©se
                        </label>
                        <div class="form__input-group">
                            <input 
                                type="number" 
                                class="form__control" 
                                id="offline_messages.retention_days" 
                                name="offline_messages.retention_days"
                                value="<%= offlineMessagesRetentionDays %>"
                                min="1"
                                max="365"
                                required
                            />
                            <span class="form__input-group-text">nap</span>
                        </div>
                        <small class="form__hint">
                            H√°ny napig jelenjenek meg a lez√°rt (‚úÖ) √©s elvett (‚ùå) offline √ºzenetek az admin fel√ºleten (1-365 nap)
                        </small>
                    </div>
                </div>

                <!-- Proactive Engagement -->
                <div class="card--data">
                    <h3 class="section-title">
                        üöÄ Proakt√≠v Engagement
                    </h3>
                    
                    <!-- Proactive Enabled -->
                    <div class="form__group">
                        <div class="form__label-with-toggle">
                            <span class="form__label">Proakt√≠v Aktiv√°l√°s</span>
                            <input type="checkbox" 
                                   class="form-switch-input"
                                   name="chat.proactive_enabled" 
                                   id="chat.proactive_enabled"
                                   value="true"
                                   <%= proactiveEnabled ? 'checked' : '' %>>
                        </div>
                        <small class="form__hint">
                            A chat gomb pulz√°l, majd automatikusan megny√≠lik kontextu√°lis √ºdv√∂zl√©ssel
                        </small>
                    </div>

                    <!-- Proactive Delay -->
                    <div class="form__group">
                        <label class="form__label" for="chat.proactive_delay">
                            ‚è±Ô∏è Aktiv√°l√°si K√©sleltet√©s
                        </label>
                        <div class="form__input-group">
                            <input 
                                type="number" 
                                class="form__control" 
                                id="chat.proactive_delay" 
                                name="chat.proactive_delay"
                                value="<%= proactiveDelay %>"
                                min="10"
                                max="120"
                                required
                            />
                            <span class="form__input-group-text">m√°sodperc</span>
                        </div>
                        <small class="form__hint">
                            Mennyi id≈ë ut√°n aktiv√°l√≥djon (10-120 mp)
                        </small>
                    </div>
                </div>
            </form>
        </div>

        <!-- Jobb oldal: Info Panels -->
        <div>
            <!-- Proakt√≠v chat -->
            <div class="card--data">
                <h3 class="section-title">
                    üöÄ Proakt√≠v M≈±k√∂d√©s
                </h3>
                
                <div class="text-sm leading-relaxed">
                    <p class="m-0 mb-4">
                        <strong>üéØ Mi t√∂rt√©nik?</strong>
                    </p>
                    
                    <ol class="m-0 pl-5">
                        <li class="mb-2">L√°togat√≥ a megadott id≈ët t√∂lt az oldalon</li>
                        <li class="mb-2">Chat gomb pulz√°lni kezd (figyelem felkelt√©s)</li>
                        <li class="mb-2">2 mp m√∫lva automatikusan megny√≠lik</li>
                        <li>Kontextu√°lis √ºdv√∂zl√©s jelenik meg az oldal alapj√°n</li>
                    </ol>
                </div>
            </div>

            <!-- Tippek -->
            <div class="card--data">
                <h3 class="section-title">
                    üí° Aj√°nl√°sok
                </h3>
                
                <div class="text-sm leading-relaxed">
                    <p class="m-0 mb-4">
                        <strong>‚è∞ Auto-offline:</strong><br>
                        Javasolt: 15-20 perc. T√∫l r√∂vid ‚Üí gyakori logout, t√∫l hossz√∫ ‚Üí nem reag√°l√≥ admin.
                    </p>
                    
                    <p class="m-0 mb-4">
                        <strong>üöÄ Proakt√≠v delay:</strong><br>
                        Javasolt: 30-45 mp. Ne legyen t√∫l gyors (zavar√≥), de ne is t√∫l lass√∫.
                    </p>
                    
                    <p class="m-0">
                        <strong>üìÖ √úzenet meg≈ërz√©s:</strong><br>
                        Javasolt: 14 nap. Lehet≈ëv√© teszi a lez√°rt √ºzenetek ut√≥lagos ellen≈ërz√©s√©t, de nem torl√≥dik fel a lista.
                    </p>
                </div>
            </div>

            <!-- Offline Messages Info -->
            <div class="card--data">
                <h3 class="section-title">
                    üì® Offline √úzenetek
                </h3>
                
                <div class="text-sm leading-relaxed">
                    <p class="m-0 mb-4">
                        <strong>üîÑ Mi t√∂rt√©nik lez√°r√°s ut√°n?</strong>
                    </p>
                    
                    <ol class="m-0 pl-5">
                        <li class="mb-2">√úzenet lez√°r√°sa (‚úÖ) vagy elvet√©se (‚ùå)</li>
                        <li class="mb-2">√Åtl√°tsz√≥ megjelen√©s, m≈±veleti gombok elt≈±nnek</li>
                        <li class="mb-2">Be√°ll√≠tott napig l√°that√≥ marad (vizu√°lis visszajelz√©s)</li>
                        <li>Automatikusan elt≈±nik a list√°b√≥l a megadott id≈ë ut√°n</li>
                    </ol>
                    
                    <p class="m-0 mt-4 pt-4 border-t">
                        <strong>üìä Haszn√°lati esetek:</strong><br>
                        ‚Ä¢ 7 nap: Nagy forgalm√∫ webshop<br>
                        ‚Ä¢ 14 nap: K√∂zepes forgalom (alap√©rtelmezett)<br>
                        ‚Ä¢ 30 nap: Alacsony forgalom, hosszabb ellen≈ërz√©s
                    </p>
                </div>
            </div>

            <!-- St√°tusz -->
            <div class="card--data">
                <h3 class="section-title">
                    ‚è≥ Jelenlegi √Ållapot
                </h3>
                
                <div class="text-sm">
                    <div class="flex justify-between py-2 border-b">
                        <span>Chat rendszer:</span>
                        <strong class="<%= chatEnabled ? 'text-success' : 'text-muted' %>">
                            <%= chatEnabled ? '‚úì Akt√≠v' : '‚úó Kikapcsolva' %>
                        </strong>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span>AI asszisztens:</span>
                        <strong class="<%= aiEnabled ? 'text-success' : 'text-muted' %>">
                            <%= aiEnabled ? '‚úì Akt√≠v' : '‚úó Kikapcsolva' %>
                        </strong>
                    </div>
                    <div class="flex justify-between py-2 border-b">
                        <span>√ârt√©kes√≠t≈ëi chat:</span>
                        <strong class="<%= adminChatEnabled ? 'text-success' : 'text-muted' %>">
                            <%= adminChatEnabled ? '‚úì Akt√≠v' : '‚úó Kikapcsolva' %>
                        </strong>
                    </div>
                    <div class="flex justify-between py-2">
                        <span>Proakt√≠v:</span>
                        <strong class="<%= proactiveEnabled ? 'text-success' : 'text-muted' %>">
                            <%= proactiveEnabled ? '‚úì Akt√≠v' : '‚úó Kikapcsolva' %>
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const csrfToken = '<%= csrfToken %>';

    // Handle individual switch changes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', async (e) => {
            const name = e.target.name;
            const value = e.target.checked ? 'true' : 'false';
            await saveSetting(name, value);
        });
    });

    // Handle number input changes (save on blur)
    document.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('blur', async (e) => {
            const name = e.target.name;
            const value = e.target.value;
            
            // Validate min/max
            const min = parseInt(e.target.min);
            const max = parseInt(e.target.max);
            const numValue = parseInt(value);
            
            if (numValue < min || numValue > max) {
                showAlert('error', `√ârt√©k ${min} √©s ${max} k√∂z√∂tt kell legyen`);
                e.target.value = e.target.defaultValue;
                return;
            }
            
            await saveSetting(name, value);
        });
    });

    // Save a single setting
    async function saveSetting(name, value) {
        const data = { [name]: value };
        
        try {
            const response = await fetch('/admin/chat/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('success', result.message || 'Be√°ll√≠t√°s sikeresen mentve!');
                
                // No page reload needed - the toggle switch already reflects the new state
                // The database save completed successfully in the background
                // If you need to see other updated data, increase timeout to 1500ms like other admin pages
            } else {
                showAlert('error', result.message || 'Hiba t√∂rt√©nt a ment√©s sor√°n');
                
                // On error, revert the toggle switch to its previous state
                const toggle = document.querySelector(`input[onchange*="${name}"]`);
                if (toggle) {
                    toggle.checked = !toggle.checked;
                }
            }
        } catch (error) {
            console.error('Save error:', error);
            showAlert('error', 'Hiba t√∂rt√©nt a ment√©s sor√°n: ' + error.message);
        }
    }

    // Show alert function
    function showAlert(type, message) {
        // Remove existing alerts
        document.querySelectorAll('.alert').forEach(alert => {
            if (alert.classList.contains('alert-success') || alert.classList.contains('alert-error')) {
                alert.remove();
            }
        });
        
        // Create new alert
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.style.cssText = 'margin-bottom: 1.5rem; animation: slideDown 0.3s ease-out; position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
        alert.innerHTML = type === 'success' 
            ? `‚úÖ ${message}`
            : `‚ùå ${message}`;
        
        document.body.appendChild(alert);
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
            alert.style.animation = 'slideUp 0.3s ease-out';
            setTimeout(() => alert.remove(), 300);
        }, 3000);
    }
</script>


