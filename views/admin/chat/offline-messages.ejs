<!-- Offline Messages Page -->


<div class="page-container">

    <!-- Alert Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success mb-3">
            ‚úì <%= success %>
        </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-error mb-3">
            ‚ö†Ô∏è <%= error %>
        </div>
    <% } %>

    <!-- 2-Column Grid Layout -->
    <div class="admin-two-col">
        
        <!-- Left Column: Main Content -->
        <div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-auto-fit gap-6 mb-4">
        
        <!-- Sent Count -->
        <div class="card--data card--data--accent border-success">
            <div class="text-4xl font-bold text-success mb-1">
                <%= messages.filter(m => m.status === 'sent').length %>
            </div>
            <div class="text-secondary text-sm font-semibold uppercase tracking-wider">
                Elk√ºldve
            </div>
        </div>

        <!-- Replied Count -->
        <div class="card--data card--data--accent border-primary">
            <div class="text-4xl font-bold text-primary mb-1">
                <%= messages.filter(m => m.status === 'replied').length %>
            </div>
            <div class="text-secondary text-sm font-semibold uppercase tracking-wider">
                Lez√°rva
            </div>
        </div>

        <!-- Archived Count -->
        <div class="card--data card--data--accent border-secondary">
            <div class="text-4xl font-bold text-secondary mb-1">
                <%= messages.filter(m => m.status === 'archived').length %>
            </div>
            <div class="text-secondary text-sm font-semibold uppercase tracking-wider">
                Elvetve
            </div>
        </div>

    </div>

    <!-- Messages Table -->
    <div class="card--data">
        <div class="p-6 border-b">
            <h5 class="m-0 font-semibold">Be√©rkezett √úzenetek</h5>
        </div>
        
        <% if (messages && messages.length > 0) { %>
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>D√°tum</th>
                            <th>K√ºld≈ë</th>
                            <th>St√°tusz</th>
                            <th>M≈±veletek</th>
                        </tr>
                    </thead>
                    <tbody>
                    <% messages.forEach((msg, index) => { 
                        // Row state classes using design system
                        let rowClass = '';
                        if (msg.status === 'pending') {
                            rowClass = 'row-error'; // Email send failed
                        } else if (msg.status === 'replied' || msg.status === 'archived') {
                            rowClass = 'row-inactive'; // Closed message (retention period)
                        }
                    %>
                        <tr class="<%= rowClass %>">
                            <!-- D√°tum -->
                            <td>
                                <div class="text-sm text-secondary">
                                    <% 
                                    const timestamp = msg.createdAt || msg.created_at;
                                    if (timestamp) {
                                        const date = new Date(timestamp);
                                    %>
                                        <div class="whitespace-nowrap">
                                            <%= date.toLocaleDateString('hu-HU', { 
                                                year: 'numeric', 
                                                month: 'short', 
                                                day: 'numeric'
                                            }) %>
                                        </div>
                                        <div class="whitespace-nowrap text-xs opacity-75">
                                            <%= date.toLocaleTimeString('hu-HU', { 
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            }) %>
                                        </div>
                                    <% } else { %>
                                        -
                                    <% } %>
                                </div>
                            </td>
                            
                            <!-- K√ºld≈ë -->
                            <td>
                                <div class="font-semibold"><%= msg.name %></div>
                            </td>

                            <!-- St√°tusz -->
                            <td>
                                <% 
                                    let badgeClass = 'badge-secondary';
                                    let statusText = msg.status;
                                    let statusIcon = 'üîµ';
                                    
                                    if (msg.status === 'pending') {
                                        badgeClass = 'badge-error';
                                        statusText = 'Email k√ºld√©s sikertelen';
                                        statusIcon = '‚ö†Ô∏è';
                                    } else if (msg.status === 'sent') {
                                        badgeClass = 'badge-info';
                                        statusText = 'Email elk√ºldve';
                                        statusIcon = '‚úâÔ∏è';
                                    } else if (msg.status === 'replied') {
                                        badgeClass = 'badge-success';
                                        statusText = 'Lez√°rva';
                                        statusIcon = '‚úÖ';
                                    } else if (msg.status === 'archived') {
                                        badgeClass = 'badge-secondary';
                                        statusText = 'Elvetve';
                                        statusIcon = '‚ùå';
                                    }
                                %>
                                <div>
                                    <span class="badge <%= badgeClass %>">
                                        <%= statusIcon %>
                                        <%= statusText %>
                                    </span>
                                    
                                    <% if (msg.email_sent_at) { %>
                                        <div class="mt-2 text-xs text-secondary">
                                            ‚úâÔ∏è <%= new Date(msg.email_sent_at).toLocaleString('hu-HU') %>
                                        </div>
                                    <% } %>
                                    
                                    <% if (msg.replied_at) { %>
                                        <div class="mt-1 text-xs text-secondary">
                                            ‚Ü©Ô∏è <%= new Date(msg.replied_at).toLocaleString('hu-HU') %>
                                        </div>
                                    <% } %>
                                </div>
                            </td>

                            <!-- M≈±veletek -->
                            <td>
                                <div class="flex gap-2 items-center">
                                    <% if (msg.status === 'pending') { %>
                                        <!-- Email √∫jrak√ºld√©se gomb pending √ºzenetekhez -->
                                        <form method="POST" action="/admin/chat/offline-messages/<%= msg.id %>/resend-email" class="inline resend-email-form">
                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                            <button type="button" onclick="confirmResendEmail(this.form)" class="btn btn-icon-only btn--warning" title="Email √∫jrak√ºld√©se">
                                                üìß
                                            </button>
                                        </form>
                                    <% } %>
                                    
                                    <% if (msg.status === 'pending' || msg.status === 'sent') { %>
                                        <form method="POST" action="/admin/chat/offline-messages/<%= msg.id %>/reply" class="inline reply-form">
                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                            <button type="button" onclick="confirmReply(this.form)" class="btn btn-icon-only btn--success" title="Lez√°r√°s">
                                                ‚úÖ
                                            </button>
                                        </form>
                                    <% } %>
                                    
                                    <% if (msg.status !== 'archived' && msg.status !== 'replied') { %>
                                        <form method="POST" action="/admin/chat/offline-messages/<%= msg.id %>/archive" class="inline archive-form">
                                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                            <button type="button" onclick="confirmArchive(this.form)" class="btn btn-icon-only btn-error" title="Elvet√©s">
                                                ‚ùå
                                            </button>
                                        </form>
                                    <% } %>
                                    
                                    <button 
                                        class="btn btn-icon-only btn--primary" 
                                        onclick='showFullMessage(<%= JSON.stringify({
                                            id: msg.id,
                                            status: msg.status,
                                            name: msg.name,
                                            email: msg.email,
                                            phone: msg.phone,
                                            createdAt: msg.createdAt || msg.created_at,
                                            message: msg.message
                                        }) %>)'
                                        title="R√©szletek"
                                    >
                                        üëÅÔ∏è
                                    </button>
                                </div>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
            </div>
        <% } else { %>
            <div class="p-12 text-center text-secondary">
                üì• <p class="m-0 text-lg">Nincs offline √ºzenet</p>
            </div>
        <% } %>
    </div>

        </div>
        <!-- End of Left Column -->

        <!-- Right Column: Info Boxes -->
        <div>
            
            <!-- Info Box 1: √úzenet St√°tuszok -->
            <div class="card--data">
                <h3>üìã √úzenet St√°tuszok</h3>
                <div class="card__info-content">
                    <p><strong>‚ö†Ô∏è Email k√ºld√©s sikertelen:</strong> Az √ºzenet automatikus email k√ºld√©se sikertelen volt. FONTOS: Az admin <strong>nem kapott √©rtes√≠t√©st</strong>! Kattints a üìß gombra az email √∫jrak√ºld√©s√©hez, vagy a rendszer automatikusan √∫jrapr√≥b√°lja 15 percenk√©nt.</p>
                    <p><strong>‚úâÔ∏è Email elk√ºldve:</strong> Az √ºzenetr≈ël √©rtes√≠t≈ë email sikeresen elk√ºld√©sre ker√ºlt az adminisztr√°tornak.</p>
                    <p><strong>‚úÖ Lez√°rva:</strong> Az √ºzenetre v√°lasz √©rkezett (emailben vagy telefonon), a besz√©lget√©s lez√°rult.</p>
                    <p><strong>‚ùå Elvetve:</strong> Az √ºzenet spam, felesleges, vagy nem ig√©nyel v√°laszt.</p>
                    <p class="mt-3 text-sm text-secondary"><strong>üìÖ Meg≈ërz√©si id≈ë:</strong> A lez√°rt √©s elvett √ºzenetek <%= retentionDays %> napig l√°that√≥ak maradnak (cs√∂kkentett √°tl√°tsz√≥s√°ggal), majd automatikusan elt≈±nnek a list√°b√≥l. <a href="/admin/chat/settings" class="text-primary">Be√°ll√≠t√°s m√≥dos√≠t√°sa ‚Üí</a></p>
                </div>
            </div>            <!-- Info Box 2: Offline √úzenetek M≈±k√∂d√©se -->
            <div class="card--data">
                <h3>‚ÑπÔ∏è M≈±k√∂d√©s</h3>
                <div class="card__info-content">
                    <p>Az offline √ºzenetek akkor √©rkeznek be, amikor a l√°togat√≥k a chat widget seg√≠ts√©g√©vel √ºzenetet k√ºldenek, de nincs el√©rhet≈ë oper√°tor vagy a chat rendszer offline m√≥dban van.</p>
                    <p>Az √ºzenetek automatikusan elt√°rol√°sra ker√ºlnek √©s √©rtes√≠t√©s √©rkezik az adminisztr√°toroknak az √∫j be√©rkezett √ºzenetekr≈ël emailben.</p>
                    <p><strong>Automata √∫jrak√ºld√©s:</strong> Ha az email k√ºld√©s sikertelen, a rendszer 15 percenk√©nt automatikusan √∫jrapr√≥b√°lja.</p>
                </div>
            </div>

            <!-- Info Box 3: V√°laszad√°s -->
            <div class="card--data">
                <h3>‚Ü©Ô∏è V√°laszad√°s</h3>
                <div class="card__info-content">
                    <p>Az offline √ºzenetekre v√°laszolni e-mailen vagy telefonon kereszt√ºl lehet:</p>
                    <ul>
                        <li>Kattints az <strong>e-mail c√≠mre</strong> a r√©szletek modalban a v√°laszad√°shoz</li>
                        <li>Vagy haszn√°ld a <strong>telefonsz√°mot</strong>, ha el√©rhet≈ë</li>
                        <li>A <strong>‚úÖ (z√∂ld pipa)</strong> gombbal jel√∂lheted meg az √ºzenetet lez√°rtk√©nt - a lez√°rt √ºzenet <%= retentionDays %> napig l√°that√≥ marad cs√∂kkentett √°tl√°tsz√≥s√°ggal</li>
                        <li>Az <strong>‚ùå gomb</strong>bal vetheted el a felesleges √ºzeneteket - az elvett √ºzenetek szint√©n <%= retentionDays %> napig l√°that√≥ak</li>
                    </ul>
                    <p class="mt-2 text-sm text-info">üí° A lez√°rt √ºzenetekn√©l a m≈±veleti gombok elt≈±nnek, √≠gy v√©letlen√ºl sem m√≥dos√≠thatod a st√°tuszt.</p>
                </div>
            </div>

            <!-- Info Box 4: Email √öjrak√ºld√©s -->
            <div class="card--data">
                <h3>ÔøΩ Email √öjrak√ºld√©s</h3>
                <div class="card__info-content">
                    <p>Ha az email k√ºld√©s sikertelen (‚ö†Ô∏è st√°tusz), k√©t lehet≈ës√©ged van:</p>
                    <ul>
                        <li><strong>Automata √∫jrak√ºld√©s:</strong> A rendszer 15 percenk√©nt automatikusan √∫jrapr√≥b√°lja a sikertelen emaileket</li>
                        <li><strong>Manu√°lis √∫jrak√ºld√©s:</strong> Kattints a üìß gombra az azonnali √∫jrak√ºld√©shez</li>
                    </ul>
                    <p class="text-error font-semibold">FONTOS: Email k√ºld√©s sikertelen eset√©n az admin NEM kapott √©rtes√≠t√©st az √ºzenetr≈ël!</p>
                </div>
            </div>

            <!-- Info Box 5: E-mail √ârtes√≠t√©sek -->
            <div class="card--data">
                <h3>‚úâÔ∏è E-mail √ârtes√≠t√©sek</h3>
                <div class="card__info-content">
                    <p>Az offline √ºzenet rendszer automatikus e-mail √©rtes√≠t√©st k√ºld az adminoknak:</p>
                    <ul>
                        <li><strong>Adminoknak:</strong> √ârtes√≠t√©s √∫j offline √ºzenet √©rkez√©sekor a be√°ll√≠tott booking email c√≠mre</li>
                        <li><strong>Tartalom:</strong> K√ºld≈ë neve, email, telefon, √ºzenet tartalma</li>
                        <li><strong>Direkt link:</strong> Az emailben link van az admin fel√ºletre</li>
                    </ul>
                </div>
            </div>

            <!-- Info Box 6: L√°togat√≥ Adatok -->
            <div class="card--data">
                <h3>üë§ L√°togat√≥ Inform√°ci√≥k</h3>
                <div class="card__info-content">
                    <p>Minden offline √ºzenet tartalmazza:</p>
                    <ul>
                        <li><strong>N√©v:</strong> A l√°togat√≥ √°ltal megadott n√©v</li>
                        <li><strong>E-mail:</strong> K√∂telez≈ë mez≈ë a visszajelz√©shez</li>
                        <li><strong>Telefon:</strong> Opcion√°lis mez≈ë</li>
                        <li><strong>√úzenet:</strong> A l√°togat√≥ k√©rd√©se vagy megjegyz√©se</li>
                        <li><strong>Id≈ëb√©lyeg:</strong> Az √ºzenet be√©rkez√©s√©nek pontos ideje</li>
                    </ul>
                </div>
            </div>

        </div>
        <!-- End of Right Column -->

    </div>
    <!-- End of Grid -->

</div>

<script>
/**
 * Show offline message details using Design System Modal
 * Uses design-system/components/modal.css and design-system/modal.js
 */
function showFullMessage(data) {
    // Format date
    let formattedDate = '';
    if (data.createdAt) {
        const date = new Date(data.createdAt);
        formattedDate = date.toLocaleString('hu-HU', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // Build phone row if available
    const phoneRow = data.phone ? `
        <div class="flex items-start gap-3">
            <span class="text-secondary font-semibold min-w-100">Telefon:</span>
            <a href="tel:${data.phone}" class="text-blue">${data.phone}</a>
        </div>
    ` : '';
    
    // Build modal content using design system structure
    const content = `
        <div class="mb-6 pb-6 border-b">
            <h6 class="text-sm font-semibold text-secondary mb-3">üë§ K√ºld≈ë adatai</h6>
            <div class="space-y-2">
                <div class="flex items-start gap-3">
                    <span class="text-secondary font-semibold min-w-100">N√©v:</span>
                    <span class="text-primary">${data.name}</span>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-secondary font-semibold min-w-100">Email:</span>
                    <a href="mailto:${data.email}" class="text-blue">${data.email}</a>
                </div>
                ${phoneRow}
                <div class="flex items-start gap-3">
                    <span class="text-secondary font-semibold min-w-100">Id≈ëpont:</span>
                    <span class="text-secondary">${formattedDate}</span>
                </div>
            </div>
        </div>
        
        <div>
            <h6 class="text-sm font-semibold text-secondary mb-3">üìù √úzenet</h6>
            <div class="whitespace-pre-wrap leading-relaxed text-primary bg-gray-50 p-4 rounded">${data.message}</div>
        </div>
    `;
    
    // Build footer with conditional action buttons
    let footer = `<button type="button" class="btn btn--secondary modal-cancel">Bez√°r√°s</button>`;
    
    if (data.id && (data.status === 'pending' || data.status === 'sent')) {
        footer = `
            <button type="button" class="btn btn--secondary modal-cancel">Bez√°r√°s</button>
            <form method="POST" action="/admin/chat/offline-messages/${data.id}/reply" class="inline m-0">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn--success">‚úÖ Lez√°r√°s</button>
            </form>
            <form method="POST" action="/admin/chat/offline-messages/${data.id}/archive" class="inline m-0">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button type="submit" class="btn btn-error">‚ùå Elvet√©s</button>
            </form>
        `;
    }
    
    // Create and open modal using Design System Modal
    const modal = Modal.create({
        title: 'Offline √úzenet R√©szletei',
        content: content,
        footer: footer,
        size: 'md',
        closeOnBackdrop: true,
        closeOnEscape: true
    });
    modal.open();
    
    // Bind cancel button event listener
    setTimeout(() => {
        const cancelBtn = modal.modalElement.querySelector('.modal-cancel');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => modal.close());
        }
    }, 0);
}

/**
 * Confirm reply (lez√°r√°s) action with Design System Modal
 * Uses modal.js showConfirmModal() global helper
 */
function confirmReply(form) {
    showConfirmModal(
        '√úzenet lez√°r√°sa',
        'Biztosan lez√°rod ezt az offline √ºzenetet?\n\nEzzel meger≈ës√≠ted, hogy v√°laszolt√°l az √ºgyf√©lnek emailben vagy telefonon.',
        'warning'
    ).then((confirmed) => {
        if (confirmed) {
            form.submit();
        }
    });
}

/**
 * Confirm archive (elvet√©s) action with Design System Modal
 * Uses modal.js showConfirmModal() global helper
 */
function confirmArchive(form) {
    showConfirmModal(
        '√úzenet elvet√©se',
        'Biztosan elveted ezt az offline √ºzenetet?\n\nAz √ºzenet elt≈±nik az akt√≠v list√°b√≥l. Ezt a m≈±veletet nem lehet visszavonni.',
        'error'
    ).then((confirmed) => {
        if (confirmed) {
            form.submit();
        }
    });
}

/**
 * Confirm email resend action with Design System Modal
 * Uses modal.js showConfirmModal() global helper
 */
function confirmResendEmail(form) {
    showConfirmModal(
        'Email √∫jrak√ºld√©se',
        'Biztosan √∫jrak√ºld√∂d az email √©rtes√≠t√©st?\n\nAz adminisztr√°tor email c√≠mre √∫jra kik√ºld√©sre ker√ºl az offline √ºzenet.',
        'info'
    ).then((confirmed) => {
        if (confirmed) {
            form.submit();
        }
    });
}
</script>
