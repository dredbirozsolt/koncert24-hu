
<div class="page-container">
  <!-- Header -->
  <div class="page-header page-header-spacing">
    <a href="/admin/users" class="btn btn--secondary">
      ‚Üê Vissza a felhaszn√°l√≥khoz
    </a>
  </div>

  <% if (messages.error) { %>
  <div class="alert alert-error"><%= messages.error %></div>
  <% } %>

  <!-- Form -->
  <form method="POST" action="<%= isEdit ? `/admin/users/${userData.id}` : '/admin/users' %>">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <div class="admin-two-col">
      <!-- Bal oldal: Alapadatok -->
      <div>
        <div class="card--data">
          <h3 class="section-title">
            <%= isEdit ? 'Felhaszn√°l√≥ Szerkeszt√©se' : '√öj Felhaszn√°l√≥' %>
          </h3>

          <div class="form__group">
            <label for="name">Teljes n√©v *</label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              class="form__control" 
              value="<%= userData.name || '' %>" 
              required
              placeholder="pl. Nagy J√°nos"
            >
          </div>

          <div class="form__group">
            <label for="email">Email c√≠m *</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              class="form__control" 
              value="<%= userData.email || '' %>" 
              required
              placeholder="pelda@email.hu"
            >
            <small class="form__hint">Ez lesz a bejelentkez√©si felhaszn√°l√≥n√©v</small>
          </div>

          <div class="form__group">
            <label for="phone">Telefonsz√°m *</label>
            <input 
              type="tel" 
              id="phone" 
              name="phone" 
              class="form__control" 
              value="<%= userData.phone || '' %>" 
              required 
              placeholder="+36301234567"
            >
            <small class="form__hint">Nemzetk√∂zi form√°tumban aj√°nlott (pl. +36301234567)</small>
          </div>

          <!-- Avatar felt√∂lt√©s -->
          <div class="form__group">
            <label for="avatar">Avatar</label>
            
            <% if (userData.avatar) { %>
            <div class="flex justify-center mb-4">
              <img src="<%= userData.avatar %>" 
                   alt="User Avatar" 
                   class="max-w-xs max-h-200 rounded-lg">
            </div>
            <% } %>
            
            <div>
              <input type="file" 
                     id="avatarFile" 
                     name="userAvatar"
                     class="hidden"
                     accept="image/jpeg,image/png,image/gif,image/webp"
                     onchange="updateAvatarFileName(this)">
              <div class="btn__group btn__group--equal">
                <button type="button" class="btn btn--secondary" onclick="document.getElementById('avatarFile').click()">
                  üì§ F√°jl kiv√°laszt√°sa
                </button>
                <button type="button" class="btn btn--primary" onclick="uploadAvatar()">
                  ‚¨ÜÔ∏è Felt√∂lt√©s
                </button>
                <% if (userData.avatar) { %>
                <button type="button" class="btn btn--outline" onclick="deleteAvatar()">
                  üóëÔ∏è T√∂rl√©s
                </button>
                <% } %>
              </div>
              <small id="avatar-file-name-display" class="form__hint m-0 hidden"></small>
              <small class="form__hint m-0">Max. 2MB ‚Ä¢ JPEG, PNG, GIF, WebP</small>
            </div>
            
            <input type="hidden" 
                   name="avatar" 
                   id="avatar"
                   value="<%= userData.avatar || '' %>">
          </div>

          <div class="form__group">
            <label for="bio">Szerz≈ë bemutatkoz√°s</label>
            <textarea 
              id="bio" 
              name="bio" 
              class="form__control" 
              rows="4"
              placeholder="Koncertszervez≈ë √©s zeneipari szak√©rt≈ë..."
            ><%= userData.bio || '' %></textarea>
            <small class="form__hint">R√∂vid bemutatkoz√°s a blog oldalon t√∂rt√©n≈ë megjelen√©shez</small>
          </div>

          <div class="form__group">
            <label for="role">Szerepk√∂r *</label>
            <select id="role" name="role" class="form__control" required>
              <option value="">-- V√°lassz szerepk√∂rt --</option>
              <option value="admin" <%= userData.role === 'admin' ? 'selected' : '' %>>
                Adminisztr√°tor
              </option>
              <option value="sales" <%= userData.role === 'sales' ? 'selected' : '' %>>
                √ârt√©kes√≠t≈ë
              </option>
              <option value="client" <%= userData.role === 'client' ? 'selected' : '' %>>
                Megrendel≈ë
              </option>
              <option value="performer" <%= userData.role === 'performer' ? 'selected' : '' %>>
                El≈ëad√≥
              </option>
            </select>
            <small class="form__hint">A szerepk√∂r hat√°rozza meg a jogosults√°gokat</small>
          </div>

          <div class="form__group">
            <label for="password">
              Jelsz√≥ <%= isEdit ? '(hagyd √ºresen, ha nem v√°ltoztatsz)' : '*' %>
            </label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              class="form__control" 
              <%= isEdit ? '' : 'required' %>
              placeholder="Minimum 6 karakter"
            >
            <small class="form__hint">
              <%= isEdit ? 'Csak akkor add meg, ha meg szeretn√©d v√°ltoztatni' : 'Minimum 6 karakter hossz√∫s√°g sz√ºks√©ges' %>
            </small>
          </div>

          <div class="form__group">
            <div class="form__switch-row">
              <span class="form__switch-row-label">Akt√≠v felhaszn√°l√≥</span>
              <input 
                type="checkbox" 
                class="form-switch-input"
                name="isActive" 
                id="isActive"
                <%= (userData.isActive === undefined || userData.isActive) ? 'checked' : '' %>
              >
            </div>
            <small class="form__hint">Az inakt√≠v felhaszn√°l√≥k nem tudnak bejelentkezni</small>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions form-actions-border">
            <div class="btn__group btn__group--equal">
              <button type="submit" class="btn btn--primary">
                <%= isEdit ? 'Ment√©s' : 'L√©trehoz√°s' %>
              </button>
              <a href="/admin/users" class="btn btn--secondary">
                M√©gse
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Jobb oldal: Info Panel -->
      <div>
        <!-- Szerepk√∂r√∂k -->
        <div class="card--data">
          <h3 class="section-title">
            Szerepk√∂r√∂k
          </h3>
          
          <div class="role-cards-container">
            <div class="role-card">
              <strong>üëë Adminisztr√°tor</strong><br>
              <span class="role-description">
                Teljes hozz√°f√©r√©s minden funkci√≥hoz, felhaszn√°l√≥ kezel√©s
              </span>
            </div>

            <div class="role-card">
              <strong>üíº √ârt√©kes√≠t≈ë</strong><br>
              <span class="role-description">
                Chat kezel√©s, user adatok megtekint√©se (csak olvashat√≥)
              </span>
            </div>

            <div class="role-card">
              <strong>üé´ Megrendel≈ë</strong><br>
              <span class="role-description">
                Foglal√°si folyamat, saj√°t adatok kezel√©se
              </span>
            </div>

            <div class="role-card">
              <strong>üé§ El≈ëad√≥</strong><br>
              <span class="role-description">
                Saj√°t profil kezel√©se, el√©rhet≈ës√©g be√°ll√≠t√°sa
              </span>
            </div>
          </div>
        </div>

        <!-- Biztons√°gi tippek -->
        <div class="card--data card-margin-top">
          <h3 class="section-title">
            Biztons√°gi tippek
          </h3>
          
          <div class="security-tips">
            <p>
              <strong>üîí Er≈ës jelsz√≥:</strong><br>
              Haszn√°lj min. 8 karaktert, sz√°mokat √©s speci√°lis karaktereket
            </p>
            
            <p>
              <strong>‚úâÔ∏è Email c√≠m:</strong><br>
              Ellen≈ërizd, hogy helyesen √≠rtad-e be
            </p>
            
            <p>
              <strong>üõ°Ô∏è Szerepk√∂r:</strong><br>
              Csak a sz√ºks√©ges jogosults√°gokat add meg
            </p>
          </div>
        </div>

        <% if (isEdit && userData.id) { %>
        <!-- Felhaszn√°l√≥ inform√°ci√≥k -->
        <div class="card--data card-margin-top">
          <h3 class="section-title">
            Felhaszn√°l√≥ info
          </h3>
          
          <div class="user-metadata">
            <p>
              <strong>üÜî User ID:</strong><br>
              #<%= userData.id %>
            </p>
            
            <% if (userData.createdAt) { %>
            <p>
              <strong>üìÖ Regisztr√°ci√≥:</strong><br>
              <%= new Date(userData.createdAt).toLocaleDateString('hu-HU') %>
            </p>
            <% } %>
            
            <% if (userData.lastLoginAt) { %>
            <p>
              <strong>üïí Utols√≥ bel√©p√©s:</strong><br>
              <%= new Date(userData.lastLoginAt).toLocaleDateString('hu-HU') %>
            </p>
            <% } %>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </form>
</div>

<% if (isEdit && userData.id) { %>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const isActiveSwitch = document.getElementById('isActive');
  
  if (isActiveSwitch) {
    isActiveSwitch.addEventListener('change', async function() {
      const isActive = this.checked;
      const userId = <%= userData.id %>;
      
      try {
        const response = await fetch(`/admin/users/${userId}/toggle-active`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('input[name="_csrf"]').value
          },
          body: JSON.stringify({ isActive })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Sikeres ment√©s - opcion√°lis visszajelz√©s
          console.log('√Ållapot friss√≠tve:', isActive ? 'Akt√≠v' : 'Inakt√≠v');
        } else {
          // Hiba eset√©n vissza√°ll√≠tjuk az eredeti √°llapotot
          this.checked = !isActive;
          alert(data.message || 'Hiba t√∂rt√©nt a ment√©s sor√°n');
        }
      } catch (error) {
        console.error('Hiba:', error);
        // Hiba eset√©n vissza√°ll√≠tjuk az eredeti √°llapotot
        this.checked = !isActive;
        alert('Hiba t√∂rt√©nt a ment√©s sor√°n');
      }
    });
  }
});

// Avatar file name display
function updateAvatarFileName(input) {
  const fileNameEl = document.getElementById('avatar-file-name-display');
  
  if (input.files && input.files[0]) {
    const fileName = input.files[0].name;
    const fileSize = (input.files[0].size / 1024).toFixed(2);
    fileNameEl.textContent = `üìÑ ${fileName} (${fileSize} KB)`;
    fileNameEl.classList.remove('hidden', 'text-secondary');
    fileNameEl.classList.add('text-primary');
  } else {
    fileNameEl.classList.add('hidden');
  }
}

// Upload avatar
async function uploadAvatar() {
  const fileInput = document.getElementById('avatarFile');
  const userId = <%= userData.id %>;
  
  if (!fileInput.files || !fileInput.files[0]) {
    alert('‚ö†Ô∏è K√©rlek v√°lassz ki egy k√©pf√°jlt!');
    return;
  }
  
  const formData = new FormData();
  formData.append('userAvatar', fileInput.files[0]);
  
  try {
    const response = await fetch(`/admin/users/${userId}/upload-avatar`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('input[name="_csrf"]').value
      },
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert(`‚úÖ ${data.message || 'Avatar sikeresen felt√∂ltve!'}`);
      document.getElementById('avatar').value = data.avatarPath;
      setTimeout(() => window.location.reload(), 1500);
    } else {
      alert(`‚ùå ${data.message || 'Hiba t√∂rt√©nt a felt√∂lt√©s sor√°n'}`);
    }
  } catch (error) {
    alert(`‚ùå H√°l√≥zati hiba: ${error.message}`);
  }
}

// Delete avatar
async function deleteAvatar() {
  const userId = <%= userData.id %>;
  
  if (!confirm('Biztosan t√∂r√∂lni szeretn√©d az avatart? Ez a m≈±velet nem vonhat√≥ vissza.')) {
    return;
  }
  
  try {
    const response = await fetch(`/admin/users/${userId}/delete-avatar`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('input[name="_csrf"]').value
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert(`‚úÖ ${data.message || 'Avatar sikeresen t√∂r√∂lve!'}`);
      document.getElementById('avatar').value = '';
      setTimeout(() => window.location.reload(), 1500);
    } else {
      alert(`‚ùå ${data.message || 'Hiba t√∂rt√©nt a t√∂rl√©s sor√°n'}`);
    }
  } catch (error) {
    alert(`‚ùå H√°l√≥zati hiba: ${error.message}`);
  }
}
</script>
<% } %>


