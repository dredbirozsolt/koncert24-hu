<!-- Admin Partners Management -->
<div class="page-container">
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>√ñsszes Partner</h3>
            <div class="stat-value"><%= partners.length %></div>
        </div>
        <div class="stat-card" style="border-left-color: #10b981;">
            <h3>Akt√≠v</h3>
            <div class="stat-value"><%= partners.filter(p => p.status === 'active').length %></div>
        </div>
        <div class="stat-card" style="border-left-color: #f59e0b;">
            <h3>F√ºgg≈ëben</h3>
            <div class="stat-value"><%= partners.filter(p => p.status === 'pending').length %></div>
        </div>
        <div class="stat-card" style="border-left-color: #8b5cf6;">
            <h3>Backlinkkel</h3>
            <div class="stat-value"><%= partners.filter(p => p.backlinkUrl && p.isVerified).length %></div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <form method="GET" action="/admin/partners">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Keres√©s</label>
                    <input type="text" name="search" class="form-control"
                           placeholder="N√©v vagy weboldal..."
                           value="<%= filters.search || '' %>">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>St√°tusz</label>
                    <select name="status" class="form-select">
                        <option value="">√ñsszes</option>
                        <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Akt√≠v</option>
                        <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>Inakt√≠v</option>
                        <option value="pending" <%= filters.status === 'pending' ? 'selected' : '' %>>F√ºgg≈ëben</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Kateg√≥ria</label>
                    <select name="categoryId" class="form-select">
                        <option value="">√ñsszes</option>
                        <% if (categories && categories.length > 0) { %>
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat.id %>" <%= filters.categoryId == cat.id ? 'selected' : '' %>>
                                    <% if (cat.icon) { %><i class="<%= cat.icon %>"></i> <% } %>
                                    <%= cat.name %>
                                </option>
                            <% }); %>
                        <% } %>
                    </select>
                </div>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Sz≈±r√©s
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Action Buttons -->
    <div style="margin-bottom: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
        <a href="/admin/partners/categories" class="btn btn-secondary">
            <i class="fas fa-cog"></i> Kateg√≥ri√°k kezel√©se
        </a>
        <a href="/admin/partners/new" class="btn btn-primary">
            <i class="fas fa-plus"></i> √öj Partner
        </a>
    </div>

    <!-- Partners Table -->
    <div class="data-card">
        <% if (partners.length === 0) { %>
            <div class="empty-state">
                <i class="fas fa-handshake" style="font-size: 4rem; color: #d1d5db;"></i>
                <h3 style="margin: 1rem 0; color: #374151;">M√©g nincsenek partnerek</h3>
                <p>Kezdj el partnereket hozz√°adni!</p>
                <a href="/admin/partners/new" class="btn btn-primary" style="margin-top: 1rem;">
                    <i class="fas fa-plus"></i> Els≈ë Partner Hozz√°ad√°sa
                </a>
            </div>
        <% } else { %>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Logo</th>
                            <th>Partner</th>
                            <th>Kateg√≥ria</th>
                            <th>Weboldal</th>
                            <th>Backlink</th>
                            <th>St√°tusz</th>
                            <th>Sorrend</th>
                            <th>M≈±veletek</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% partners.forEach(partner => { %>
                            <tr>
                                <td data-label="Logo">
                                    <% if (partner.logo) { %>
                                        <img src="<%= partner.logo %>" 
                                             alt="<%= partner.name %> log√≥" 
                                             title="<%= partner.name %>" 
                                             width="100" 
                                             height="50" 
                                             style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; border: 2px solid #e5e7eb; padding: 4px;">
                                    <% } else { %>
                                        <i class="fas fa-image" style="font-size: 2rem; color: #9ca3af;"></i>
                                    <% } %>
                                </td>
                                <td data-label="Partner">
                                    <strong><%= partner.name %></strong>
                                    <% if (partner.contactName) { %>
                                        <br><small style="color: #6b7280;"><%= partner.contactName %></small>
                                    <% } %>
                                </td>
                                <td data-label="Kateg√≥ria">
                                    <% if (partner.category) { %>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <% if (partner.category.icon) { %>
                                                <i class="<%= partner.category.icon %>" style="color: <%= partner.category.color || '#667eea' %>; font-size: 1.25rem;"></i>
                                            <% } %>
                                            <span><%= partner.category.name %></span>
                                        </div>
                                    <% } else { %>
                                        <span style="color: #9ca3af;">-</span>
                                    <% } %>
                                </td>
                                <td data-label="Weboldal">
                                    <a href="<%= partner.websiteUrl %>" target="_blank" style="color: #667eea;">
                                        <%= partner.websiteUrl.replace(/^https?:\/\/(www\.)?/, '') %>
                                    </a>
                                </td>
                                <td data-label="Backlink">
                                    <% if (partner.backlinkUrl && partner.isVerified) { %>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span class="badge badge-success" style="white-space: nowrap;">
                                                ‚úÖ Ellen≈ërizve
                                            </span>
                                            <button class="btn-icon verify-backlink" 
                                                    data-id="<%= partner.id %>"
                                                    title="√öjraellen≈ërz√©s"
                                                    style="font-size: 1.2rem;">
                                                üîÑ
                                            </button>
                                        </div>
                                    <% } else if (partner.backlinkUrl) { %>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span class="badge badge-warning" style="white-space: nowrap;">
                                                üïê F√ºgg≈ëben
                                            </span>
                                            <button class="btn-icon verify-backlink" 
                                                    data-id="<%= partner.id %>"
                                                    title="Backlink ellen≈ërz√©se"
                                                    style="font-size: 1.2rem;">
                                                üîç
                                            </button>
                                        </div>
                                    <% } else { %>
                                        <span style="color: #9ca3af;">-</span>
                                    <% } %>
                                </td>
                                <td data-label="St√°tusz">
                                    <% if (partner.status === 'active') { %>
                                        <span class="badge" style="background: #d1fae5; color: #065f46; font-weight: 600;">
                                            Akt√≠v
                                        </span>
                                    <% } else { %>
                                        <span class="badge" style="background: #fee2e2; color: #991b1b; font-weight: 600;">
                                            Inakt√≠v
                                        </span>
                                    <% } %>
                                </td>
                                <td data-label="Sorrend"><%= partner.displayOrder %></td>
                                <td data-label="M≈±veletek">
                                    <div class="actions">
                                        <a href="/admin/partners/<%= partner.id %>/edit" class="btn-icon" style="color: #3b82f6;" title="Szerkeszt√©s">
                                            ‚úèÔ∏è
                                        </a>
                                        <button class="btn-icon delete-partner" 
                                                data-id="<%= partner.id %>" 
                                                data-name="<%= partner.name %>"
                                                style="color: #ef4444;"
                                                title="T√∂rl√©s">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        <% } %>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h5>Partner T√∂rl√©se</h5>
        </div>
        <div class="modal-body">
            Biztosan t√∂r√∂lni szeretn√©d a(z) <strong id="deletePartnerName"></strong> partnert?
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">M√©gse</button>
            <form method="POST" id="deleteForm" style="margin: 0;">
                <button type="submit" class="btn" style="background: #ef4444; color: white;">T√∂rl√©s</button>
            </form>
        </div>
    </div>
</div>

<script>
function closeModal() {
    document.getElementById('deleteModal').classList.remove('show');
}

document.querySelectorAll('.delete-partner').forEach(btn => {
    btn.addEventListener('click', function() {
        document.getElementById('deletePartnerName').textContent = this.dataset.name;
        document.getElementById('deleteForm').action = `/admin/partners/${this.dataset.id}/delete`;
        document.getElementById('deleteModal').classList.add('show');
    });
});

document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// Backlink ellen≈ërz√©s
document.querySelectorAll('.verify-backlink').forEach(btn => {
    btn.addEventListener('click', async function() {
        const partnerId = this.dataset.id;
        const originalText = this.innerHTML;
        
        // Bet√∂lt√©s jelz√©se
        this.innerHTML = '‚è≥';
        this.disabled = true;
        
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            const response = await fetch(`/admin/partners/${partnerId}/verify-backlink`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.isVerified) {
                    UniversalModal.success('Backlink sikeresen ellen≈ërizve! A link megtal√°lhat√≥ a partner oldal√°n.');
                } else {
                    UniversalModal.error('A backlink nem tal√°lhat√≥ a partner oldal√°n.');
                }
                // Oldal friss√≠t√©se az √∫j st√°tusz megjelen√≠t√©s√©hez
                window.location.reload();
            } else {
                UniversalModal.error('Hiba: ' + result.error);
                this.innerHTML = originalText;
                this.disabled = false;
            }
        } catch (error) {
            console.error('Backlink ellen≈ërz√©si hiba:', error);
            UniversalModal.error('Hiba t√∂rt√©nt az ellen≈ërz√©s sor√°n.');
            this.innerHTML = originalText;
            this.disabled = false;
        }
    });
});
</script>
