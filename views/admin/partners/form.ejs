<!-- Partner Szerkeszt√©se -->
<div class="page-container">
  <!-- Header -->
  <div class="mb-4">
    <div class="flex justify-end items-center">
      <a href="/admin/partners" class="btn btn--secondary">
        ‚Üê Vissza
      </a>
    </div>
  </div>

  <!-- Form -->
  <form method="POST" action="/admin/partners<%= isEdit ? '/' + partner.id : '' %>" enctype="multipart/form-data" id="partnerForm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <div class="admin-two-col">
      <!-- Bal oldal: Alapadatok -->
      <div>
        <!-- Alapadatok -->
        <div class="card--data">
          <h3 class="section-title">Alapadatok</h3>

          <div class="form__group">
            <label for="name">Partner neve *</label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              class="form__control"
              placeholder="pl. Example Szervez≈ë Kft."
              value="<%= partner.name || '' %>"
              required
            >
          </div>

          <div class="form__group">
            <label for="websiteUrl">Weboldal URL *</label>
            <input 
              type="url" 
              id="websiteUrl" 
              name="websiteUrl" 
              class="form__control"
              placeholder="https://example.com"
              value="<%= partner.websiteUrl || '' %>"
              required
            >
          </div>

          <div class="form__group">
            <label for="description">Le√≠r√°s</label>
            <textarea 
              id="description" 
              name="description" 
              class="form__control"
              rows="4"
              placeholder="R√∂vid le√≠r√°s a partnerr≈ël..."
            ><%= partner.description || '' %></textarea>
          </div>
        </div>

        <!-- Backlink -->
        <div class="card--data mt-6">
          <h3 class="section-title">Backlink Inform√°ci√≥k</h3>

          <div class="form__group">
            <label for="backlinkUrl">Backlink URL</label>
            <div class="flex gap-2">
              <input 
                type="url" 
                id="backlinkUrl" 
                name="backlinkUrl" 
                class="form__control flex-1"
                placeholder="https://partner.com/visszahivatkozas"
                value="<%= partner.backlinkUrl || '' %>"
              >
              <% if (isEdit) { %>
                <button 
                  type="button" 
                  class="btn btn--secondary whitespace-nowrap" 
                  onclick="verifyBacklink()" 
                  id="verifyBtn"
                  title="Backlink ellen≈ërz√©se"
                >
                  <span id="verifyBtnText"><%= partner.lastVerified ? '√öjraellen≈ërz√©s' : 'Ellen≈ërz√©s' %></span>
                </button>
              <% } %>
            </div>
            <small class="form__hint">Az oldal URL-je, ahol a backlink tal√°lhat√≥</small>
          </div>

          <% if (isEdit) { %>
            <div 
              id="verifyStatus" 
              class="p-3 rounded-lg mt-3 <%= partner.isVerified ? 'alert-success' : 'alert-error' %> <%= partner.isVerified || partner.lastVerified ? '' : 'hidden' %>"
            >
              <div class="flex justify-between items-center">
                <span id="verifyStatusText">
                  <%= partner.isVerified ? '‚úÖ Backlink ellen≈ërizve - Megtal√°lva!' : '‚ùå Backlink nem tal√°lhat√≥' %>
                </span>
                <% if (partner.lastVerified) { %>
                  <small class="opacity-80" id="verifyTimestamp">
                    <%= new Date(partner.lastVerified).toLocaleString('hu-HU') %>
                  </small>
                <% } %>
              </div>
            </div>
          <% } %>

          <div class="form__grid-1-1 <%= isEdit && (partner.isVerified || partner.lastVerified) ? 'mt-4' : '' %>">
            <div class="form__group">
              <label for="domainAuthority">Domain Authority</label>
              <input 
                type="number" 
                id="domainAuthority" 
                name="domainAuthority" 
                class="form__control"
                placeholder="0-100"
                value="<%= partner.domainAuthority || '' %>"
                min="0"
                max="100"
              >
            </div>

            <div class="form__group">
              <label for="pageAuthority">Page Authority</label>
              <input 
                type="number" 
                id="pageAuthority" 
                name="pageAuthority" 
                class="form__control"
                placeholder="0-100"
                value="<%= partner.pageAuthority || '' %>"
                min="0"
                max="100"
              >
            </div>
          </div>

          <div class="form__group">
            <div class="form__switch-row">
              <span class="form__switch-row-label">Backlink ellen≈ërizve</span>
              <input 
                type="checkbox" 
                class="form-switch-input"
                name="isVerified" 
                id="isVerified"
                <%= partner.isVerified ? 'checked' : '' %>
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Jobb oldal: Be√°ll√≠t√°sok √©s Logo -->
      <div>
        <!-- Be√°ll√≠t√°sok -->
        <div class="card--data">
          <h3 class="section-title">Be√°ll√≠t√°sok</h3>

          <div class="form__group">
            <label for="categoryId">Kateg√≥ria *</label>
            <select id="categoryId" name="categoryId" class="form__control" required>
              <option value="">-- V√°lassz kateg√≥ri√°t --</option>
              <% if (typeof categories !== 'undefined' && categories.length > 0) { %>
                <% categories.forEach(cat => { %>
                  <option 
                    value="<%= cat.id %>" 
                    <%= partner.categoryId == cat.id ? 'selected' : '' %>
                  >
                    <% if (cat.icon) { %><i class="<%= cat.icon %>"></i> <% } %>
                    <%= cat.name %>
                  </option>
                <% }); %>
              <% } %>
            </select>
            <small class="form__hint">
              <a href="/admin/partners/categories" target="_blank">
                ‚öôÔ∏è Kateg√≥ri√°k kezel√©se
              </a>
            </small>
          </div>

          <div class="form__group">
            <label for="partnershipType">T√≠pus *</label>
            <select id="partnershipType" name="partnershipType" class="form__control" required>
              <option value="organic" <%= !partner.partnershipType || partner.partnershipType === 'organic' ? 'selected' : '' %>>Organikus</option>
              <option value="reciprocal" <%= partner.partnershipType === 'reciprocal' ? 'selected' : '' %>>K√∂lcs√∂n√∂s</option>
              <option value="sponsored" <%= partner.partnershipType === 'sponsored' ? 'selected' : '' %>>Szponzor√°lt</option>
              <option value="affiliate" <%= partner.partnershipType === 'affiliate' ? 'selected' : '' %>>Affiliate</option>
            </select>
          </div>

          <div class="form__group">
            <label for="status">St√°tusz *</label>
            <select id="status" name="status" class="form__control" required>
              <option value="pending" <%= !partner.status || partner.status === 'pending' ? 'selected' : '' %>>F√ºgg≈ëben</option>
              <option value="active" <%= partner.status === 'active' ? 'selected' : '' %>>Akt√≠v</option>
              <option value="inactive" <%= partner.status === 'inactive' ? 'selected' : '' %>>Inakt√≠v</option>
              <option value="rejected" <%= partner.status === 'rejected' ? 'selected' : '' %>>Elutas√≠tva</option>
            </select>
          </div>

          <div class="form__group">
            <label for="displayOrder">Sorrend</label>
            <input 
              type="number" 
              id="displayOrder" 
              name="displayOrder" 
              class="form__control"
              placeholder="0"
              value="<%= partner.displayOrder || 0 %>"
              min="0"
            >
            <small class="form__hint">Alacsonyabb sz√°m = el≈ër√©bb jelenik meg</small>
          </div>

          <div class="form__group mb-0">
            <div class="form__switch-row">
              <span class="form__switch-row-label">F≈ëoldalon megjelen√≠t√©s</span>
              <input type="checkbox" 
                     class="form-switch-input"
                     name="showOnHomepage" 
                     <%= (isEdit && partner.showOnHomepage) ? 'checked' : '' %>>
            </div>
          </div>
        </div>

        <!-- Logo -->
        <div class="card--data mt-6">
          <h3 class="section-title">Logo</h3>

          <!-- F√°jl felt√∂lt√©s -->
          <div class="form__group">
            <label for="logo">Logo felt√∂lt√©se</label>
            <div class="flex gap-3 items-center flex-wrap">
              <input 
                type="file" 
                id="logo" 
                name="logo" 
                class="hidden"
                accept="image/*"
                onchange="previewLogo(event)"
              >
              <button type="button" class="btn btn--secondary" onclick="document.getElementById('logo').click()">
                üì§ F√°jl kiv√°laszt√°sa
              </button>
            </div>
            <div id="logo-file-name" class="text-secondary text-sm italic mt-2">
              Nincs f√°jl kiv√°lasztva
            </div>
            <small class="form__hint">JPG, PNG, GIF, SVG, WebP (max 2MB)</small>
          </div>

          <!-- Jelenlegi logo -->
          <% if (partner.logo) { %>
            <div id="currentLogo" class="mt-4 text-center">
              <div class="text-sm text-secondary mb-2">
                Jelenlegi logo:
              </div>
              <img 
                src="<%= partner.logo %>" 
                alt="Logo" 
                class="max-w-150 max-h-150 border-2 border-base rounded-lg p-2 bg-white"
              >
              <div class="mt-3">
                <button 
                  type="button" 
                  onclick="deleteCurrentLogo()" 
                  class="btn btn-error"
                >
                  üóëÔ∏è Logo elt√°vol√≠t√°sa
                </button>
              </div>
            </div>
          <% } %>

          <!-- El≈ën√©zet -->
          <div id="logoPreview" class="hidden mt-4 text-center">
            <div class="text-sm text-secondary mb-2">
              √öj logo el≈ën√©zet:
            </div>
            <img 
              id="logoPreviewImg" 
              src="" 
              alt="Preview" 
              class="max-w-150 max-h-150 border-2 rounded-lg p-2 bg-white border-primary"
            >
            <div class="mt-2">
              <button 
                type="button" 
                onclick="removeLogo()" 
                class="btn btn--secondary text-sm py-2 px-4"
              >
                ‚úñÔ∏è M√©gse
              </button>
            </div>
          </div>

          <!-- Logo URL alternat√≠va -->
          <div class="form__group mt-4 mb-0">
            <label for="logoUrl">Vagy Logo URL</label>
            <input 
              type="url" 
              id="logoUrl" 
              name="logoUrl" 
              class="form__control"
              placeholder="https://example.com/logo.png"
              value="<%= partner.logo && partner.logo.startsWith('http') ? partner.logo : '' %>"
            >
            <small class="form__hint">Ha URL-t adsz meg, nem kell f√°jlt felt√∂lteni</small>
          </div>
        </div>

        <!-- M≈±veletek -->
        <div class="card--data mt-6">
          <button type="submit" class="btn btn--primary btn--block mb-2">
            üíæ <%= isEdit ? 'Ment√©s' : 'L√©trehoz√°s' %>
          </button>

          <a href="/admin/partners" class="btn btn--secondary btn--block">
            ‚úñÔ∏è M√©gse
          </a>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
// Logo el≈ën√©zet
function previewLogo(event) {
  const file = event.target.files[0];
  const fileNameDiv = document.getElementById('logo-file-name');
  
  if (file) {
    // F√°jln√©v megjelen√≠t√©se
    fileNameDiv.textContent = 'üìÑ ' + file.name;
    fileNameDiv.classList.remove('text-secondary', 'italic');
    fileNameDiv.classList.add('text-primary');
    
    // El≈ën√©zet bet√∂lt√©se
    const reader = new FileReader();
    reader.onload = function(e) {
      const previewImg = document.getElementById('logoPreviewImg');
      const logoPreview = document.getElementById('logoPreview');
      const currentLogo = document.getElementById('currentLogo');
      
      previewImg.src = e.target.result;
      logoPreview.classList.remove('hidden');
      
      if (currentLogo) {
        currentLogo.classList.add('hidden');
      }
    };
    reader.readAsDataURL(file);
  } else {
    // Ha nincs f√°jl, vissza√°ll√≠tjuk az alap√©rtelmezett sz√∂veget
    fileNameDiv.textContent = 'Nincs f√°jl kiv√°lasztva';
    fileNameDiv.classList.remove('text-primary');
    fileNameDiv.classList.add('text-secondary', 'italic');
  }
}

// Logo elt√°vol√≠t√°sa
function removeLogo() {
  const logoInput = document.getElementById('logo');
  const logoPreview = document.getElementById('logoPreview');
  const currentLogo = document.getElementById('currentLogo');
  const fileNameDiv = document.getElementById('logo-file-name');
  
  logoInput.value = '';
  logoPreview.classList.add('hidden');
  
  // F√°jln√©v vissza√°ll√≠t√°sa alap√©rtelmezettre
  fileNameDiv.textContent = 'Nincs f√°jl kiv√°lasztva';
  fileNameDiv.classList.remove('text-primary');
  fileNameDiv.classList.add('text-secondary', 'italic');
  
  if (currentLogo) {
    currentLogo.classList.remove('hidden');
  }
}

// Jelenlegi logo t√∂rl√©se
function deleteCurrentLogo() {
  if (!confirm('Biztosan t√∂r√∂lni szeretn√©d a jelenlegi log√≥t?')) {
    return;
  }
  
  const currentLogo = document.getElementById('currentLogo');
  const fileNameDiv = document.getElementById('logo-file-name');
  
  // Jelenlegi logo elrejt√©se
  if (currentLogo) {
    currentLogo.classList.add('hidden');
  }
  
  // Hidden input hozz√°ad√°sa a t√∂rl√©s jelz√©s√©re
  const deleteInput = document.createElement('input');
  deleteInput.type = 'hidden';
  deleteInput.name = 'deleteLogo';
  deleteInput.value = 'true';
  document.querySelector('form').appendChild(deleteInput);
  
  // F√°jln√©v friss√≠t√©se
  fileNameDiv.textContent = 'Logo t√∂r√∂lve - ment√©s ut√°n v√©gleges√≠tve';
  fileNameDiv.classList.remove('text-secondary', 'italic');
  fileNameDiv.classList.add('text-error');
}

<% if (isEdit) { %>
// Backlink ellen≈ërz√©s
async function verifyBacklink() {
  const verifyBtn = document.getElementById('verifyBtn');
  const verifyBtnText = document.getElementById('verifyBtnText');
  const verifyStatus = document.getElementById('verifyStatus');
  const verifyStatusText = document.getElementById('verifyStatusText');
  const verifyTimestamp = document.getElementById('verifyTimestamp');
  const backlinkUrl = document.getElementById('backlinkUrl').value;
  
  if (!backlinkUrl) {
    alert('K√©rlek add meg a backlink URL-t!');
    return;
  }
  
  // Gomb letilt√°sa ellen≈ërz√©s k√∂zben
  verifyBtn.disabled = true;
  verifyBtnText.innerHTML = 'Ellen≈ërz√©s...';
  document.getElementById('verifyBtnIcon').textContent = '‚è≥';
  
  try {
    const response = await fetch('/admin/partners/<%= partner.id %>/verify-backlink', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    // St√°tusz megjelen√≠t√©se
    verifyStatus.classList.remove('hidden');
    
    if (result.success && result.isVerified) {
      verifyStatus.style.background = 'var(--color-success-100)';
      verifyStatus.style.color = 'var(--color-success-900)';
      verifyStatusText.innerHTML = '‚úì ‚úÖ Backlink ellen≈ërizve - Megtal√°lva!';
      document.getElementById('verifyBtnIcon').textContent = 'üîÑ';
      verifyBtnText.innerHTML = '√öjraellen≈ërz√©s';
    } else {
      verifyStatus.style.background = 'var(--color-error-50)';
      verifyStatus.style.color = 'var(--color-error-800)';
      verifyStatusText.innerHTML = '‚úñÔ∏è ‚ùå ' + (result.error || 'Backlink nem tal√°lhat√≥');
      document.getElementById('verifyBtnIcon').textContent = 'üîÑ';
      verifyBtnText.innerHTML = '√öjraellen≈ërz√©s';
    }
    
    // Timestamp friss√≠t√©se
    const now = new Date().toLocaleString('hu-HU');
    if (verifyTimestamp) {
      verifyTimestamp.textContent = now;
    } else {
      verifyStatus.querySelector('div').innerHTML += `<small class="opacity-80" id="verifyTimestamp">${now}</small>`;
    }
    
  } catch (error) {
    console.error('Hiba:', error);
    alert('Hiba t√∂rt√©nt az ellen≈ërz√©s sor√°n');
    verifyBtnText.innerHTML = 'Ellen≈ërz√©s';
  } finally {
    // Gomb vissza√°ll√≠t√°sa
    verifyBtn.disabled = false;
  }
}
<% } %>

// Partner form submit handler
document.getElementById('partnerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Ment√©s...';
    
    try {
        const formData = new FormData(form);
        
        // Relat√≠v URL haszn√°lata (form.action absolute URL-t ad vissza amit a browser gener√°l)
        const actionUrl = form.getAttribute('action');
        
        const response = await fetch(actionUrl, {
            method: 'POST',
            headers: {
                'X-CSRF-Token': '<%= csrfToken %>',
                'Accept': 'application/json'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            Modal.alert({
                title: 'Siker',
                message: data.message || 'Partner sikeresen mentve!',
                type: 'success'
            });
            window.location.href = '/admin/partners';
        } else {
            throw new Error(data.message || 'Hiba t√∂rt√©nt a ment√©s sor√°n');
        }
    } catch (error) {
        Modal.alert({
            title: 'Hiba',
            message: '‚ùå Hiba: ' + error.message,
            type: 'error'
        });
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
});
</script>


