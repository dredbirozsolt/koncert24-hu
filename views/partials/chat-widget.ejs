<!-- Chat Widget Floating Button & Window -->
<div x-data="chatWidget" x-init="init()" class="chat-widget__container">
  
  <!-- Chat Toggle Button (Floating) -->
  <button 
    @click="toggleChat()"
    class="chat-widget__toggle-btn"
    :class="{ 'hidden': isOpen }"
    aria-label="Chat megnyitása"
  >
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    
    <!-- Unread Badge -->
    <span 
      x-show="unreadCount > 0" 
      x-text="unreadCount"
      class="chat-widget__notification-badge"
    ></span>
  </button>

  <!-- Chat Window -->
  <div 
    :style="isOpen ? 'display: flex;' : 'display: none;'"
    class="chat-widget__window"
    @click.away="false"
  >
    
    <!-- Chat Header -->
    <div class="chat-widget__header">
      <div class="chat-widget__header-info">
        <div class="chat-widget__avatar">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <div class="chat-widget__header-text">
          <div class="chat-widget__header-title">Koncert24 Chat</div>
          <div class="chat-widget__header-status" x-show="!isLoading">
            <span x-show="mode === 'full_service'">AI + Munkatárs</span>
            <span x-show="mode === 'admin_only'">Munkatárs elérhető</span>
            <span x-show="mode === 'ai_only'">AI elérhető</span>
            <span x-show="mode === 'offline_mode'">Offline üzenet</span>
          </div>
        </div>
      </div>
      
      <div class="chat-widget__header-actions">
        <button 
          @click="minimizeChat()"
          class="chat-widget__header-btn"
          aria-label="Minimalizálás"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </button>
        <button 
          @click="closeChat()"
          class="chat-widget__header-btn"
          aria-label="Bezárás"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Chat Body: Absolute positioning container -->
    <div x-show="!isMinimized" class="chat-widget__body-container">
      
      <!-- Messages Container: Scrollable area with padding for input -->
      <div 
        x-show="!showOfflineForm"
        x-ref="messagesContainer"
        class="chat-widget__messages"
      >
        <!-- Loading State -->
        <div x-show="isLoading && messages.length === 0" class="chat-widget__loading">
          <div class="chat-widget__loading-spinner"></div>
          <p>Kapcsolódás...</p>
        </div>

        <!-- Messages -->
        <template x-for="message in messages" :key="message.id">
          <div 
            class="chat-widget__message"
            :class="{
              'chat-widget__message--user': message.role === 'user',
              'chat-widget__message--assistant': message.role === 'assistant',
              'chat-widget__message--admin': message.role === 'admin',
              'chat-widget__message--system': message.role === 'system'
            }"
          >
            <div class="chat-widget__message-time" x-show="message.role !== 'system'">
              <span x-text="formatTime(message.createdAt)"></span>
            </div>
            <div class="chat-widget__message-bubble">
              <div x-html="message.content" class="chat-widget__message-content"></div>
            </div>
          </div>
        </template>

        <!-- Typing Indicator: Always visible above input -->
        <div x-show="isTyping" x-transition class="chat-widget__typing-indicator">
          <div class="chat-widget__typing">
            <span class="chat-widget__typing-dot"></span>
            <span class="chat-widget__typing-dot"></span>
            <span class="chat-widget__typing-dot"></span>
          </div>
        </div>
      </div>

      <!-- Offline Form: FIXED at bottom with absolute positioning -->
      <div x-show="showOfflineForm" class="chat-widget__offline-form">
        <h3>Offline Üzenet</h3>
        <form @submit.prevent="submitOfflineForm()">
          
          <!-- Honeypot Fields - Hidden from real users but bots will fill them -->
          <input 
            name="website" 
            type="text" 
            class="honeypot"
            tabindex="-1" 
            autocomplete="off"
            aria-hidden="true"
          />
          <input 
            name="url" 
            type="text" 
            class="honeypot"
            tabindex="-1" 
            autocomplete="off"
            aria-hidden="true"
          />
          <input 
            name="homepage" 
            type="text" 
            class="honeypot"
            tabindex="-1" 
            autocomplete="off"
            aria-hidden="true"
          />
          <input 
            name="phone2" 
            type="tel" 
            class="honeypot"
            tabindex="-1" 
            autocomplete="off"
            aria-hidden="true"
          />
          <input 
            name="fax" 
            type="tel" 
            class="honeypot"
            tabindex="-1" 
            autocomplete="off"
            aria-hidden="true"
          />
          
          <input 
            x-model="offlineForm.name" 
            type="text" 
            placeholder="Név *" 
            required
            class="chat-widget__offline-input"
          />
          <input 
            x-model="offlineForm.email" 
            type="email" 
            placeholder="Email *" 
            required
            class="chat-widget__offline-input"
          />
          <input 
            x-model="offlineForm.phone" 
            type="tel" 
            placeholder="Telefon" 
            class="chat-widget__offline-input"
          />
          <textarea 
            x-model="offlineForm.message" 
            placeholder="Üzenet *" 
            required
            rows="3"
            class="chat-widget__offline-textarea"
          ></textarea>
          <button 
            type="submit" 
            :disabled="isLoading"
            class="chat-widget__offline-submit-btn"
          >
            <span x-show="!isLoading">Küldés</span>
            <span x-show="isLoading">Küldés...</span>
          </button>
        </form>
      </div>

      <!-- Input Area: FIXED at bottom with absolute positioning -->
      <div x-show="!showOfflineForm" class="chat-widget__input-area">
        <form @submit.prevent="sendMessage()" class="chat-widget__input-container">
          <input 
            type="text"
            x-model="inputMessage"
            @keydown.enter.prevent="sendMessage()"
            placeholder="Írja be üzenetét..."
            class="chat-widget__input"
          />
          <button 
            type="submit" 
            :disabled="!inputMessage.trim() || isLoading"
            class="chat-widget__send-btn"
            :class="{ 'opacity-50 cursor-not-allowed': !inputMessage.trim() || isLoading }"
          >
            <!-- Loading Spinner -->
            <div x-show="isLoading" class="flex items-center justify-center w-full h-full">
              <svg class="icon-base animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <!-- Send Icon -->
            <div x-show="!isLoading" class="flex items-center justify-center w-full h-full">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </div>
          </button>
        </form>
        
        <!-- Actions -->
        <div class="chat-widget__actions">
          <button 
            @click="escalateToSales()"
            x-show="mode === 'full_service'"
            class="chat-widget__action-btn"
          >
            Egy munkatárssal szeretnék beszélni
          </button>
          
          <!-- End Conversation Button -->
          <button 
            @click="endConversation()"
            x-show="messages.length > 0"
            class="chat-widget__action-btn chat-widget__action-btn--destructive"
            title="Beszélgetés törlése és új indítása"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            Beszélgetés törlése, új beszélgetés indítása
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
